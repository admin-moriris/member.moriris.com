<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>

  <!-- キャッシュ抑止（復旧後に外してOK） -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MORIRIS MEMBERSHIP</title>

  <style>
    :root{
      --bg:#faf8f4;
      --panel:#ffffff;
      --ink:#24311c;
      --muted:#6b6964;
      --accent:#75c29c;
      --accent-dark:#0b5130;
      --radius:20px;
      --shadow:0 10px 32px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box;}
    html,body{ margin:0; height:100%; }
    body{
      min-height:100vh;
      background-color:#faf8f4;
      background-image:url("/assets/hero-forest.png");
      background-repeat:no-repeat;
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
    }
    .page{ max-width:1120px; margin:0 auto; padding:0 18px 32px; }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:18px; }
    .brand{ display:flex; align-items:center; gap:18px; }
    .brand img{ max-width:220px; height:auto; display:block; filter:drop-shadow(0 4px 12px rgba(0,0,0,.18)); }
    .brand-title span{ font-size:20px; letter-spacing:.22em; text-transform:uppercase; color:#666666; font-weight:500; white-space:nowrap; }

    .user-box{ display:flex; align-items:center; gap:10px; font-size:13px; color:var(--muted); justify-content:flex-end; }
    .pill{ border-radius:999px; background:#ffffff; padding:4px 10px; border:1px solid rgba(0,0,0,.08); }
    .btn{
      border-radius:999px; border:1px solid #ddd; background:#fff;
      padding:7px 12px; cursor:pointer; font-size:13px; color:var(--ink);
    }
    .btn-primary{ background:var(--accent); border-color:transparent; color:var(--accent-dark); font-weight:600; }
    .btn-outline{ background:#fff; color:var(--ink); }

    .tabs{
      margin-top:8px;
      background:rgba(255,255,255,.95);
      border-radius:999px;
      box-shadow:0 4px 18px rgba(0,0,0,.08);
      padding:4px;
      display:flex;
      gap:4px;
      overflow:auto;
    }
    .tab-btn{
      flex:1; min-width:0; border:none; background:transparent;
      border-radius:999px; padding:10px 12px; font-size:14px;
      cursor:pointer; letter-spacing:.12em;
    }
    .tab-btn.active{ background:var(--accent); color:var(--accent-dark); font-weight:600; }

    main{ margin-top:40px; }
    .card{ background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px 20px 24px; margin-bottom:18px; }
    .tab-pane{display:none;}
    .tab-pane.active{display:block;}
    .muted{color:var(--muted);}
    .hidden{display:none;}

    .site-header{
      position:fixed;
      top:0; left:0; right:0;
      z-index:100;
      background: linear-gradient(to bottom, rgba(250,248,244,1) 0%, rgba(250,248,244,.95) 70%, rgba(250,248,244,0) 100%);
      backdrop-filter:blur(4px);
    }
    .main-page{ padding-top:180px; }

    @media (max-width: 768px){
      .topbar{ flex-direction:column; align-items:flex-start; gap:8px; }
      .brand{ gap:10px; }
      .brand img{ max-width:180px; }
      .brand-title span{ font-size:16px; letter-spacing:.16em; }
      .user-box{ justify-content:flex-start; flex-wrap:wrap; }
      .tabs{ border-radius:16px; padding:4px 6px; gap:6px; -webkit-overflow-scrolling:touch; }
      .tab-btn{ flex:0 0 auto; white-space:nowrap; font-size:12px; letter-spacing:.08em; padding:8px 10px; }
      .main-page{ padding-top:210px; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <header class="site-header">
    <div class="page header-inner">
      <div class="topbar">
        <div class="brand">
          <img src="/assets/logo-moriris.png" alt="Moriris" />
          <div class="brand-title"><span>MEMBERSHIP</span></div>
        </div>

        <div>
          <div class="user-box">
            <span>ログイン中：</span>
            <span id="userEmail" class="pill">-</span>
            <button id="logout" class="btn btn-outline">ログアウト</button>
          </div>
        </div>
      </div>

      <nav class="tabs">
        <button class="tab-btn active" data-tab="home">HOME</button>
        <button class="tab-btn" data-tab="animation">ANIMATION</button>
        <button class="tab-btn" data-tab="account">ACCOUNT</button>
      </nav>
    </div>
  </header>

  <div class="page main-page">
    <main>
      <!-- 未ログイン時の強制案内 -->
      <div id="notLoggedAlert" class="card hidden" style="background:#fff7e0;border:1px solid #f3d38a;">
        <p class="muted" style="font-size:14px;margin-bottom:8px;">
          ログインが必要です。ログイン画面に戻ってください。
        </p>
        <a id="notLoggedLink" href="/index.html" style="font-size:14px;">ログイン画面に戻る</a>
        <div style="margin-top:10px;">
          <button id="goLoginBtn" class="btn btn-primary">ログイン画面へ</button>
        </div>
        <p id="notLoggedDebug" class="muted" style="font-size:12px;margin-top:10px;"></p>
      </div>

      <section id="tab-home" class="tab-pane active">
        <div class="card">
          <h2 style="margin:0 0 10px;font-size:20px;">ようこそ、モリリス メンバーシップへ</h2>
          <p class="muted" style="margin:6px 0;line-height:1.7;font-size:14px;">
            ログイン状態を確認しています…
          </p>
        </div>
      </section>

      <section id="tab-animation" class="tab-pane">
        <div class="card">
          <h2 style="margin:0 0 10px;font-size:20px;">ANIMATION</h2>
          <p class="muted" style="margin:6px 0;line-height:1.7;font-size:14px;">
            ログイン状態を確認しています…
          </p>
        </div>
      </section>

      <section id="tab-account" class="tab-pane">
        <div class="card">
          <h2 style="margin:0 0 10px;font-size:20px;">ACCOUNT</h2>
          <p class="muted" style="margin:6px 0;line-height:1.7;font-size:14px;">
            ログイン状態を確認しています…
          </p>
        </div>
      </section>
    </main>
  </div>

<script>
  const SUPABASE_URL = "https://sqwyfscumunyhsvsvejv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxd3lmc2N1bXVueWhzdnN2ZWp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODM4NDQsImV4cCI6MjA3NzA1OTg0NH0.P_6eP5E_Du82IEI1gzn4PKQjnqlVGoptmZZR9aIiXNU"; // ←あなたの既存キーを貼る
  const LOGIN_URL = "/index.html";

  const sb = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    { auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true } }
  );

  const $ = (s)=>document.querySelector(s);

  function forceGoLogin(){
    // 2段構えで“絶対戻す”
    const url = LOGIN_URL + "?v=" + Date.now();
    location.replace(url);
  }

  function showNotLogged(reason){
    $("#notLoggedAlert").classList.remove("hidden");
    $("#notLoggedDebug").textContent = reason ? ("debug: " + reason) : "";
    $("#notLoggedLink").href = LOGIN_URL + "?v=" + Date.now();
    $("#goLoginBtn").onclick = forceGoLogin;
    $("#logout").onclick = forceGoLogin; // 未ログインでも押したら戻す
  }

  function bindTabs(){
    document.querySelectorAll(".tab-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const tab = btn.dataset.tab;
        document.querySelectorAll(".tab-btn").forEach(b=>b.classList.toggle("active", b===btn));
        document.querySelectorAll(".tab-pane").forEach(p=>{
          p.classList.toggle("active", p.id === "tab-"+tab);
        });
      });
    });
  }

  async function boot(){
    bindTabs();

    // ★重要：このページでは exchangeCodeForSession を絶対に呼ばない
    // （呼ぶと /auth/v1/token?grant_type=pkce 400 になりやすい）

    // セッションがあるかだけを確認
    const { data: sessRes, error: sessErr } = await sb.auth.getSession();
    if (sessErr){
      showNotLogged("getSession error: " + (sessErr.message || String(sessErr)));
      return;
    }
    const session = sessRes?.session;
    if (!session){
      showNotLogged("no session");
      return;
    }

    // ユーザー取得
    const { data: userRes, error: userErr } = await sb.auth.getUser();
    if (userErr || !userRes?.user){
      showNotLogged("getUser error: " + (userErr?.message || String(userErr)));
      return;
    }

    const user = userRes.user;
    $("#userEmail").textContent = user.email || "(no email)";

    // ログアウト
    $("#logout").onclick = async ()=>{
      try{ await sb.auth.signOut(); }catch{}
      forceGoLogin();
    };
  }

  boot();
</script>

</body>
</html>
