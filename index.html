<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Moriris Members – Login</title>
  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto;margin:24px}
    input,button{font-size:16px;padding:10px;border-radius:10px;border:1px solid #ddd}
    button{cursor:pointer}
    #msg{margin-top:12px;color:#666}
  </style>
  <!-- Supabase SDK は UMD を明示。@2 を付けない -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
</head>
<body>
  <h1>Moriris Members</h1>

  <div>
    <input id="email" type="email" placeholder="you@example.com" value="test01@moriris.com" />
    <button id="login">メール送信</button>
    <button id="to-members">会員ページへ</button>
  </div>
  <div style="margin-top:8px">
    <button id="reset">セッションをリセット</button>
  </div>
  <p id="msg"></p>

  <script>
    // ==== Supabase ====
    const SUPABASE_URL = "https://sqwyfscumunyhsvsvejv.supabase.co";
    // ダッシュボード > Project Settings > API > Legacy API Keys の anon か、
    // API Keys の Publishable key のどちらかを入れる（ここでは anon を使用）
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxd3lmc2N1bXVueWhzdnN2ZWp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODM4NDQsImV4cCI6MjA3NzA1OTg0NH0.P_6eP5E_Du82IEI1gzn4PKQjnqlVGoptmZZR9aIiXNU";

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, storageKey: 'moriris-auth' }
    });

    const $ = s => document.querySelector(s);
    const msg = $("#msg");

    $("#login").onclick = async () => {
      msg.textContent = "送信中…";
      const email = $("#email").value.trim();
      if (!email) { msg.textContent = "メールを入力してください。"; return; }

      const { error } = await sb.auth.signInWithOtp({
        email,
        options: {
          shouldCreateUser: true,
          // Supabase の Auth 設定 > Redirect URLs にこのURLを登録しておく
          emailRedirectTo: "https://member.moriris.com/members.html"
        }
      });

      msg.textContent = error ? `Error: ${error.message||error.name}` : "OK。メールをご確認ください。";
    };

    $("#to-members").onclick = () => location.href = "./members.html";

    $("#reset").onclick = async () => {
      try { await sb.auth.signOut(); } catch {}
      try { localStorage.removeItem('moriris-auth'); } catch {}
      msg.textContent = "セッションをクリアしました。";
    };
  </script>
</body>
</html>
