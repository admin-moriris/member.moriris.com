<!doctype html>
<meta charset="utf-8" />
<title>OTP Minimal Test</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

<h1>OTP Minimal Test</h1>
<p id="msg"></p>

<label>Email: <input id="email" type="email" value="test01@moriris.com" style="width:320px"/></label>
<button id="send">メール送信</button>

<pre id="log" style="background:#f6f6f6;padding:12px;border:1px solid #eee"></pre>

<script>
  // ← ここにあなたの Supabase プロジェクト情報を記入
  const SUPABASE_URL = "https://sqwyfscumunyhsvsvejv.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxd3lmc2N1bXVueWhzdnN2ZWp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODM4NDQsImV4cCI6MjA3NzA1OTg0NH0.P_6eP5E_Du82IEI1gzn4PKQjnqlVGoptmZZR9aIiXNU";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: false }
  });

  const log = (...a)=>{ document.getElementById('log').textContent += a.map(x=>(
    typeof x==='string'?x:JSON.stringify(x,null,2))).join(' ') + '\n'; };

  document.getElementById('send').onclick = async () => {
    document.getElementById('msg').textContent = '';
    document.getElementById('log').textContent = '';
    const email = document.getElementById('email').value.trim();
    if (!email) { document.getElementById('msg').textContent = 'emailが空です'; return; }

    // 送信前に現在のキーとURLを表示
    log('url', SUPABASE_URL);
    log('key_prefix', SUPABASE_ANON_KEY.slice(0, 16));

    const { data, error } = await sb.auth.signInWithOtp({
      email,
      options: {
        shouldCreateUser: true, // 新規作成を許可
        emailRedirectTo: 'https://member.moriris.com/members.html'
      }
    });

    log('otp result', { data, error, message: error?.message });
    document.getElementById('msg').textContent = error ? `Error: ${error.message||error.name}` : 'OK';
  };
</script>
