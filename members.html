<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Moriris Members – Videos</title>
  <style>
    body{font-family:system-ui;margin:16px}
    .top{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:16px}
    .card{border:1px solid #ddd;border-radius:12px;overflow:hidden}
    .title{padding:10px 12px;font-weight:600}
    .frame-wrap{position:relative;background:#000;aspect-ratio:16/9}
    .overlay{position:absolute;inset:0;background:transparent}
    .hidden{display:none}
    .muted{color:#666}
    pre#dbg{white-space:pre-wrap;background:#f6f6f6;border:1px solid #eee;padding:12px;border-radius:8px}
  </style>
</head>
<body>
  <div class="top">
    <h1>Members Videos</h1>
    <div>
      <span id="user"></span>
      <button id="logout">ログアウト</button>
    </div>
  </div>

  <p id="status" class="muted">ログイン状態を確認しています…</p>
  <pre id="dbg" class="hidden"></pre>

  <div id="gate" class="hidden">
    <p>会員ではありません。<a href="./">ログインページへ戻る</a></p>
  </div>

  <div id="list" class="grid hidden"></div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://sqwyfscumunyhsvsvejv.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxd3lmc2N1bXVueWhzdnN2ZWp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODM4NDQsImV4cCI6MjA3NzA1OTg0NH0.P_6eP5E_Du82IEI1gzn4PKQjnqlVGoptmZZR9aIiXNU";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    const debug = new URL(location.href).searchParams.get('debug') === '1';
    const $ = s => document.querySelector(s);
    const log = (label, v) => { if (!debug) return;
      const el = $('#dbg'); el.classList.remove('hidden');
      el.textContent += `\n${label}: ${JSON.stringify(v, null, 2)}\n`;
      console.log(label, v);
    };

    // 右クリック抑止（任意）
    document.addEventListener('contextmenu', e => e.preventDefault());

    (async () => {
      try {
        const status = $('#status');

        // ① リダイレクトで渡ってきたトークンをセッション化（?code= または #access_token=）
        // これを最初にやらないと session が永遠に null のままになります
        try { await sb.auth.exchangeCodeForSession(window.location.href); } catch(_) {}

        // ② ユーザー取得（初期化済みのはず）
        let { data: { user } } = await sb.auth.getUser();
        log('getUser(1)', { user });
        if (!user) {
          const s = await sb.auth.getSession();
          log('getSession', s);
          user = s?.data?.session?.user || null;
        }

        if (!user) {
          status.textContent = '未ログインです。';
          if (!debug) location.replace('./'); // debug=1 の時は止めて中身を見せる
          return;
        }

        $('#user').textContent = user.email || '';
        status.textContent = '会員ステータス確認中…';

        // ③ 会員（is_active）チェック
        const prof = await sb.from('profiles').select('is_active').eq('id', user.id).single();
        log('profile', prof);
        if (prof.error) { status.textContent = 'プロフィール取得エラー'; return; }
        if (!prof.data?.is_active) { status.textContent=''; $('#gate').classList.remove('hidden'); return; }

        // ④ 動画取得
        status.textContent = '動画を読み込み中…';
        const vids = await sb.from('member_videos')
          .select('id,title,yt_id')
          .eq('published', true)
          .order('id', { ascending: false });
        log('videos', vids);

        if (vids.error) { status.textContent = '動画取得エラー'; return; }

        status.textContent = '';
        const list = $('#list'); list.classList.remove('hidden');
        list.innerHTML = vids.data.map(v => `
          <div class="card">
            <div class="frame-wrap">
              <iframe
                src="https://www.youtube-nocookie.com/embed/${encodeURIComponent(v.yt_id)}?rel=0&modestbranding=1&playsinline=1&controls=1"
                title="${v.title}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen loading="lazy" style="width:100%;height:100%;position:absolute;inset:0;">
              </iframe>
              <div class="overlay"></div>
            </div>
            <div class="title">${escapeHtml(v.title)}</div>
          </div>
        `).join('');

        // ログアウト
        $('#logout').onclick = async () => { await sb.auth.signOut(); location.replace('./'); };

      } catch (e) {
        console.error(e);
        $('#status').textContent = '予期せぬエラー';
        log('exception', String(e));
      }
    })();

    function escapeHtml(s){
      return s?.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) || '';
    }
  </script>
</body>
</html>
