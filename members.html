<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>

  <!-- Google tag (gtag.js)  -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HWRX6Q9K3E"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-HWRX6Q9K3E');
  </script>
  
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MORIRIS MEMBERSHIP</title>
  <style>
    :root{
      --bg:#faf8f4;
      --panel:#ffffff;
      --ink:#24311c;
      --muted:#6b6964;
      --accent:#75c29c;
      --accent-dark:#0b5130;
      --radius:20px;
      --shadow:0 10px 32px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      height:100%;
    }
    body{
      min-height:100vh;
      background-color:#faf8f4;
      background-image:url("/assets/hero-forest.png");
      background-repeat:no-repeat;
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
    }
    .page{
      max-width:1120px;
      margin:0 auto;
      padding:0 18px 32px;
    }

    .header-wrap{
      position:sticky;
      top:0;
      z-index:100;
      padding-bottom:10px;
      background:
        linear-gradient(to bottom, rgba(250,248,244,1) 0%, rgba(250,248,244,.95) 70%, rgba(250,248,244,0) 100%);
      backdrop-filter:blur(4px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:18px;
    }
    .brand img{
      max-width:220px;
      height:auto;
      display:block;
      filter:drop-shadow(0 4px 12px rgba(0,0,0,.18));
    }
    .brand-title{
      display:flex;
      align-items:center;
    }
    .brand-title span{
      font-size:20px;
      letter-spacing:.22em;
      text-transform:uppercase;
      color:#666666;
      font-weight:500;
      white-space:nowrap;
    }

    .lang{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .lang button{
      border:1px solid #ddd;
      background:#fff;
      border-radius:999px;
      padding:6px 12px;
      cursor:pointer;
      font-size:13px;
    }
    .lang .active{
      border-color:var(--accent);
      color:var(--accent-dark);
      font-weight:600;
    }

    .user-box{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:13px;
      color:var(--muted);
      justify-content:flex-end;
    }
    .pill{
      border-radius:999px;
      background:#ffffff;
      padding:4px 10px;
      border:1px solid rgba(0,0,0,.08);
    }
    .btn{
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      padding:7px 12px;
      cursor:pointer;
      font-size:13px;
    }
    .btn-primary{
      background:var(--accent);
      border-color:transparent;
      color:var(--accent-dark);
      font-weight:600;
    }
    .btn-outline{ background:#fff; }
    .btn-danger{
      background:#ffe7e3;
      border-color:#ffb3a7;
      color:#8b1a07;
      font-weight:600;
    }
    .input{
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      padding:7px 10px;
      font-size:13px;
      min-width:220px;
    }

    .tabs{
      margin-top:8px;
      background:rgba(255,255,255,.95);
      border-radius:999px;
      box-shadow:0 4px 18px rgba(0,0,0,.08);
      padding:4px;
      display:flex;
      gap:4px;
      overflow:auto;
    }
    .tab-btn{
      flex:1;
      min-width:0;
      border:none;
      background:transparent;
      border-radius:999px;
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
      letter-spacing:.12em;
    }
    .tab-btn.active{
      background:var(--accent);
      color:var(--accent-dark);
      font-weight:600;
    }
    .add-gap {
      margin-bottom: 20px;
    }

    main{ margin-top:40px; } /* ã‚¿ãƒ–ã¨ç™½æ ã®é–“éš” */
    .card{
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px 20px 24px;
      margin-bottom:18px;
    }
    .tab-pane{display:none;}
    .tab-pane.active{display:block;}

    h2{ margin:0 0 10px; font-size:20px; }
    h3{ margin:0 0 6px; font-size:16px; }
    p{ margin:6px 0; line-height:1.7; font-size:14px; }
    .muted{color:var(--muted);}

    .home-layout{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .status-box{
      background:#f5ffe9;
      border-radius:16px;
      padding:12px 14px;
      font-size:13px;
      margin-top:8px;
    }
    .plan-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.05);
      font-size:13px;
    }
    .plan-pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#e9f8ef;
      color:#0b5130;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
    }
    .cta-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }

    .video-grid{
      display:flex;
      flex-direction:column;
      gap:22px;
      margin-top:12px;
    }

    .video-card{
      background:var(--panel);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
      width:100%;
      max-width:none;
      margin:0;
    }

    .video-title{
      padding:10px 12px 12px;
      font-size:14px;
      font-weight:600;
    }

    .video-sort{
      margin-top:6px;
      margin-bottom:6px;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .video-sort-btn{
      border-radius:999px;
      border:1px solid #ccc;
      background:#fff;
      padding:4px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .video-sort-btn.active{
      background:var(--accent);
      border-color:var(--accent);
      color:var(--accent-dark);
      font-weight:600;
    }

    /* çµµæœ¬ã¾ã‚ã‚Š */
    .book-sort{
      margin-top:6px;
      margin-bottom:6px;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .book-sort-btn{
      border-radius:999px;
      border:1px solid #ccc;
      background:#fff;
      padding:4px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .book-sort-btn.active{
      background:var(--accent);
      border-color:var(--accent);
      color:var(--accent-dark);
      font-weight:600;
    }

    .book-list{
      display:flex;
      flex-direction:column;
      gap:20px;
      margin-top:10px;
    }
    .book-entry{
      width:100%;
    }
    .book-item{
      background:#f5ffe9;
      border-radius:16px;
      padding:12px 14px 14px;
    }
    .book-title{
      font-weight:600;
      margin-bottom:4px;
    }

    .book-viewer{
      margin:12px 0 0;
      border-radius:16px;
      overflow:hidden;
      box-shadow:var(--shadow);
      background:#000;
      width:100%;
      max-width:none;
    }
    .book-viewer-inner img{
      display:block;
      width:100%;
      height:auto;
    }

    .book-viewer-nav{
      display:flex;
      align-items:center;
      padding:6px 12px;
      font-size:12px;
      background:rgba(0,0,0,.7);
      color:#ffffff;
      position:relative; 
    }
    .book-viewer-nav-left{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .book-viewer-nav-right{
      margin-left:auto;
      display:flex;
      align-items:center;
      gap:12px;
    }

    .book-viewer-btn{
      border:none;
      background:transparent;
      color:#ffffff;
      font-size:18px;
      cursor:pointer;
      padding:4px 10px;
    }

    .book-viewer-btn:focus{
      outline:2px solid rgba(255,255,255,.6);
      outline-offset:2px;
    }

    .book-viewer-page{
      font-size:12px;
      position:absolute; 
      left:50%;
      transform:translateX(-50%);  
    }

    .book-meta{
      margin-top:6px;
      font-size:13px;
    }

    .book-full-btn{
      border:none;
      background:transparent;
      cursor:pointer;
      padding:4px 8px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .book-full-btn:focus{
      outline:2px solid rgba(255,255,255,.6);
      outline-offset:2px;
    }
    .book-full-icon{
      width:20px;
      height:20px;
      display:block;
    }

    .book-viewer:fullscreen{
      border-radius:0;
    }
    .book-viewer:fullscreen .book-viewer-inner img{
      width:100%;
      height:100%;
      object-fit:contain;
    }

    a{color:#0d6b45;text-decoration:none;}
    a:hover{text-decoration:underline;}

    footer{
      margin-top:24px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }
    .sns-row{
      display:flex;
      justify-content:center;
      gap:16px;
      margin:10px 0 6px;
    }
    .sns-icon{
      width:40px;
      height:40px;
      border-radius:999px;
      background:#ffffff;
      box-shadow:0 4px 12px rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      text-decoration:none;
    }
    .sns-icon svg{
      width:20px;
      height:20px;
      fill:#3f6f4b;
    }

    .hidden{display:none;}
    pre#dbg{
      white-space:pre-wrap;
      background:#f6f6f6;
      border:1px solid #eee;
      padding:10px;
      border-radius:10px;
      font-size:11px;
      margin-top:14px;
    }

    .site-header{
      position:fixed;
      top:0;
      left:0;
      right:0;
      z-index:100;
      background:
        linear-gradient(to bottom,
          rgba(250,248,244,1) 0%,
          rgba(250,248,244,.95) 70%,
          rgba(250,248,244,0) 100%);
      backdrop-filter:blur(4px);
    }

    .main-page{
      padding-top:180px;
    }

    /* ã‚¹ãƒãƒ›å‘ã‘ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ */
    @media (max-width: 768px){
      .topbar{
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
      }
      .brand{
        gap:10px;
      }
      .brand img{
        max-width:180px;
      }
      .brand-title span{
        font-size:16px;
        letter-spacing:.16em;
      }
      .user-box{
        justify-content:flex-start;
        flex-wrap:wrap;
      }
      .lang{
        justify-content:flex-start;
      }
      .tabs{
        border-radius:16px;
        padding:4px 6px;
        gap:6px;
        -webkit-overflow-scrolling:touch;
      }
      .tab-btn{
        flex:0 0 auto;
        white-space:nowrap;
        font-size:12px;
        letter-spacing:.08em;
        padding:8px 10px;
      }
      .main-page{
        padding-top:210px;
      }
    }

    /* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .pw-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      z-index:999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .pw-card{
      max-width:480px;
      width:100%;
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px 20px 24px;
    }
    .pw-input-wrap{
      position:relative;
      display:flex;
      align-items:center;
    }
    .pw-eye-btn{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      border:none;
      background:transparent;
      cursor:pointer;
      font-size:16px;
      padding:2px 4px;
    }
    @media (max-width: 768px){
      .pw-card{
        padding:18px 16px 22px;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="site-header">
    <div class="page header-inner">
      <div class="topbar">
        <div class="brand">
          <img src="/assets/logo-moriris.png" alt="Moriris" />
          <div class="brand-title">
            <span data-i18n="brand_meta">MEMBERSHIP</span>
          </div>
        </div>

        <div>
          <div class="user-box">
            <span data-i18n="logged_in_label">ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š</span>
            <span id="userEmail" class="pill"></span>
            <button id="logout" class="btn btn-outline" data-i18n="logout">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          </div>
          <div class="lang" style="margin-top:6px;justify-content:flex-end;">
            <button id="btn-en">EN</button>
            <button id="btn-ja" class="active">JP</button>
          </div>
        </div>
      </div>

      <nav class="tabs">
        <button class="tab-btn active" data-tab="home" data-i18n="tab_home">HOME</button>
        <button class="tab-btn" data-tab="animation" data-i18n="tab_animation">ANIMATION</button>
        <button class="tab-btn" data-tab="book" data-i18n="tab_book">PICTUREBOOK</button>
        <button class="tab-btn" data-tab="account" data-i18n="tab_account">ACCOUNT</button>
      </nav>
    </div>
  </header>

  <div class="page main-page">
  <main>
    <!-- æœªãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«è¡¨ç¤ºã™ã‚‹æ¡ˆå†… -->
    <div id="notLoggedAlert" class="card hidden" style="background:#fff7e0;border:1px solid #f3d38a;">
      <p id="notLoggedText" class="muted" style="font-size:14px;margin-bottom:8px;"></p>
      <a id="notLoggedLink" href="./" style="font-size:14px;">ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹</a>
    </div>

    <!-- HOME -->
    <section id="tab-home" class="tab-pane active">
      <div class="card home-layout">
        <div>
          <h2 data-i18n="home_title">ã‚ˆã†ã“ãã€ãƒ¢ãƒªãƒªã‚¹ ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã¸</h2>
          <p class="muted" data-i18n="home_intro">
            ãƒ¡ãƒ³ãƒãƒ¼é™å®šã®ã‚¢ãƒ‹ãƒ¡ã‚„ãƒ‡ã‚¸ã‚¿ãƒ«çµµæœ¬ã‚’ã€ã“ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ãŠæ¥½ã—ã¿ã„ãŸã ã‘ã¾ã™ã€‚
          </p>

          <img
            src="https://member.moriris.com/assets/home-img.png"
            alt="Moriris members home illustration"
            style="width:100%;max-width:720px;border-radius:16px;margin:16px 0;"
          />
        </div>

        <div>
          <h3 data-i18n="home_how_title">
            ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—ã®æ¥½ã—ã¿æ–¹
          </h3>
          <ul style="margin:4px 0 0;padding-left:18px;font-size:13px;line-height:1.7;">
            <li data-i18n="home_how_1">
              ANIMATIONã‚¿ãƒ–ã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼é™å®šã‚¢ãƒ‹ãƒ¡ã‚’è¦–è´ã§ãã¾ã™ã€‚
            </li>
            <li data-i18n="home_how_2">
              PICTUREBOOKã‚¿ãƒ–ã‹ã‚‰ãƒ‡ã‚¸ã‚¿ãƒ«çµµæœ¬ã‚„é–¢é€£ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’èª­ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚
            </li>
            <li data-i18n="home_how_3">
              ãƒ—ãƒ©ãƒ³ã®ç¢ºèªã‚„å¤‰æ›´ã¯ ACCOUNTã‚¿ãƒ–ã‹ã‚‰ã„ã¤ã§ã‚‚è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
            </li>
          </ul>
        </div>
      </div>
    </section>

    <!-- ANIMATION -->
    <section id="tab-animation" class="tab-pane">
      <div class="card">
        <h2 data-i18n="anim_title">ãƒ¡ãƒ³ãƒãƒ¼é™å®šã‚¢ãƒ‹ãƒ¡</h2>
        <p class="muted" id="animGateText">
          Standardãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã™ã‚‹ã¨ã€ãƒ¡ãƒ³ãƒãƒ¼é™å®šã®ã‚¢ãƒ‹ãƒ¡ã‚’è¦–è´ã§ãã¾ã™ã€‚
        </p>

        <button id="btnSubscribeAnim"
                class="btn btn-primary hidden add-gap"
                data-i18n="btn_subscribe">
          Standardãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã™ã‚‹
        </button>

        <div class="video-sort" id="videoSortRow">
          <span data-i18n="video_sort_label">è¡¨ç¤ºé †ï¼š</span>
          <button type="button" class="video-sort-btn active" data-sort="episode" data-i18n="video_sort_episode">
            ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é †
          </button>
          <button type="button" class="video-sort-btn" data-sort="new" data-i18n="video_sort_new">
            æ–°ç€é †
          </button>
        </div>

        <div id="videos" class="video-grid"></div>
      </div>
    </section>

    <!-- PICTUREBOOK -->
    <section id="tab-book" class="tab-pane">
      <div class="card">
        <h2 data-i18n="book_title">ãƒ‡ã‚¸ã‚¿ãƒ«çµµæœ¬</h2>
        <p class="muted" id="bookIntro">
          ãƒ‡ã‚¸ã‚¿ãƒ«çµµæœ¬ã®é–²è¦§ã¯ Standard ãƒ—ãƒ©ãƒ³ç™»éŒ²å¾Œã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚
        </p>

        <button id="btnSubscribeBook"
                class="btn btn-primary hidden add-gap"
                data-i18n="btn_subscribe">
          Standardãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã™ã‚‹
        </button>

        <div class="book-sort hidden" id="bookSortRow">
          <span data-i18n="book_sort_label">è¡¨ç¤ºé †ï¼š</span>
          <button type="button" class="book-sort-btn active" data-sort="episode" data-i18n="book_sort_episode">
            ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é †
          </button>
          <button type="button" class="book-sort-btn" data-sort="new" data-i18n="book_sort_new">
            æ–°ç€é †
          </button>
        </div>

        <div class="book-list hidden" id="bookList">
          <!-- Episode 1 -->
          <div class="book-entry" data-ep="1">
            <div class="book-item">
              <div class="book-title" data-i18n="book_ep1_title">
                Moriris Picture Book â€“ Episode 1
              </div>

              <div class="book-viewer" id="bookViewerEp1">
                <div class="book-viewer-inner">
                  <img
                    id="bookEp1Image"
                    src="/assets/book-ep1/1.png"
                    alt="Moriris Picture Book Episode 1 page 1"
                  />
                </div>
                <div class="book-viewer-nav">
                  <div class="book-viewer-nav-left">
                    <button type="button"
                            class="book-viewer-btn"
                            data-book="ep1"
                            data-dir="prev">â†</button>
                    <span class="book-viewer-page" id="bookEp1PageIndicator">1 / 15</span>
                  </div>
                  <div class="book-viewer-nav-right">
                    <button type="button"
                            class="book-viewer-btn"
                            data-book="ep1"
                            data-dir="next">â†’</button>
                    <button type="button"
                            class="book-full-btn"
                            data-viewer="bookViewerEp1"
                            title="Full Screen"
                            aria-label="Full Screen">
                      <img src="/assets/expansion_icon.png" alt="" class="book-full-icon">
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Episode 2 -->
          <div class="book-entry" data-ep="2">
            <div class="book-item">
              <div class="book-title" data-i18n="book_ep2_title">
                Moriris Picture Book â€“ Episode 2
              </div>

              <div class="book-viewer" id="bookViewerEp2">
                <div class="book-viewer-inner">
                  <img
                    id="bookEp2Image"
                    src="/assets/book-ep2/1.png"
                    alt="Moriris Picture Book Episode 2 page 1"
                  />
                </div>
                <div class="book-viewer-nav">
                  <div class="book-viewer-nav-left">
                    <button type="button"
                            class="book-viewer-btn"
                            data-book="ep2"
                            data-dir="prev">â†</button>
                    <span class="book-viewer-page" id="bookEp2PageIndicator">1 / 14</span>
                  </div>
                  <div class="book-viewer-nav-right">
                    <button type="button"
                            class="book-viewer-btn"
                            data-book="ep2"
                            data-dir="next">â†’</button>
                    <button type="button"
                            class="book-full-btn"
                            data-viewer="bookViewerEp2"
                            title="Full Screen"
                            aria-label="Full Screen">
                      <img src="/assets/expansion_icon.png" alt="" class="book-full-icon">
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Kindle èª¬æ˜æ–‡ï¼‹ãƒªãƒ³ã‚¯ï¼ˆå…±é€šãƒ»ä¸€ç®‡æ‰€ã ã‘ï¼‰ -->
        <div id="bookCommonMeta" class="book-meta hidden">
          <p class="muted" data-i18n="book_common_desc">
            æ£®ã§å§‹ã¾ã‚‹å°ã•ãªå†’é™ºã®ç‰©èªã€‚Kindle ã‚¹ãƒˆã‚¢ã§ã‚‚ãŠèª­ã¿ã„ãŸã ã‘ã¾ã™ã€‚
          </p>
          <a href="https://www.amazon.co.jp/s?i=digital-text&rh=p_27%3AMoriris%2BStudio&s=relevancerank&text=Moriris+Studio&ref=dp_byline_sr_ebooks_1"
             target="_blank" rel="noopener noreferrer"
             data-i18n="book_kindle_link">
            Kindle ã‚¹ãƒˆã‚¢ã§è¦‹ã‚‹
          </a>
        </div>
      </div>
    </section>

    <!-- ACCOUNT -->
    <section id="tab-account" class="tab-pane">
      <div class="card">
        <h2 data-i18n="account_title">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ãƒ—ãƒ©ãƒ³æƒ…å ±</h2>
        <p class="muted" data-i18n="account_intro">
          ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ãƒ»è§£ç´„ã¯ã€ã“ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
        </p>

        <div class="status-box">
          <div>
            <span data-i18n="plan_label">ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ï¼š</span>
            <span id="planLabelText">Free</span>
          </div>
          <p id="statusText"
             class="muted"
             style="margin-top:6px;">
            ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™â€¦
          </p>
        </div>

        <div class="cta-row">
          <button id="btnSubscribe" class="btn btn-primary hidden" data-i18n="btn_subscribe">
            Standardãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã™ã‚‹
          </button>
          <button id="btnCancel" class="btn btn-danger hidden" data-i18n="btn_cancel">
            ã‚µãƒ–ã‚¹ã‚¯ã‚’è§£ç´„ã™ã‚‹
          </button>
          <button id="btnDeleteAccount" class="btn btn-danger hidden" data-i18n="btn_delete">
            ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹
          </button>
        </div>

        <hr style="margin:18px 0;border:none;border-top:1px solid #e0e0e0;" />

        <h3 data-i18n="email_change_title">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´</h3>
        <p class="muted" data-i18n="email_change_desc">
          æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã€‚ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å¤‰æ›´ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚
        </p>

        <p style="font-size:13px;margin-top:8px;">
          <span data-i18n="email_change_current">ç¾åœ¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š</span>
          <strong id="currentEmailText"></strong>
        </p>

        <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
          <input
            id="emailNew"
            type="email"
            class="input"
            placeholder="new-address@example.com"
          />
          <button id="btnChangeEmail" class="btn btn-outline" data-i18n="email_change_btn">
            å¤‰æ›´ç”¨ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
          </button>
        </div>

        <p id="emailChangeMsg" class="muted" style="font-size:12px;margin-top:6px;"></p>
      </div>
    </section>

    <pre id="dbg" class="hidden"></pre>
  </main>

  <footer>
    <div class="sns-row">
      <a class="sns-icon" href="https://www.youtube.com/@moriris_world"
         target="_blank" rel="noopener noreferrer" aria-label="YouTube">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M21.6 7.2s-.2-1.5-.8-2.1c-.7-.8-1.5-.8-1.9-.9C15.6 4 12 4 12 4s-3.6 0-6.9.2c-.4.1-1.2.1-1.9.9-.6.6-.8 2.1-.8 2.1S2 9.1 2 11v1.9c0 1.9.2 3.8.2 3.8s.2 1.5.8 2.1c.7.8 1.8.8 2.3.9 1.7.2 7 .3 7 .3s3.6 0 6.9-.2c.4-.1 1.2-.1 1.9-.9.6-.6.8-2.1.8-2.1s.2-1.9.2-3.8V11c0-1.9-.2-3.8-.2-3.8zM10 9.5l4.8 2.5L10 14.5V9.5z"/>
        </svg>
      </a>
      <a class="sns-icon" href="https://www.instagram.com/moriris_world"
         target="_blank" rel="noopener noreferrer" aria-label="Instagram">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 7.3A4.7 4.7 0 1 0 16.7 12 4.71 4.71 0 0 0 12 7.3zm0 7.7A3 3 0 1 1 15 12a3 3 0 0 1-3 3z"/>
          <path d="M17.2 3H6.8A3.8 3.8 0 0 0 3 6.8v10.4A3.8 3.8 0 0 0 6.8 21h10.4A3.8 3.8 0 0 0 21 17.2V6.8A3.8 3.8 0 0 0 17.2 3zm2.1 14.2a2.1 2.1 0 0 1-2.1 2.1H6.8a2.1 2.1 0 0 1-2.1-2.1V6.8a2.1 2.1 0 0 1 2.1-2.1h10.4a2.1 2.1 0 0 1 2.1 2.1z"/>
          <circle cx="17" cy="7" r="1"/>
        </svg>
      </a>
      <a class="sns-icon" href="https://x.com/moriris_world"
         target="_blank" rel="noopener noreferrer" aria-label="X">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M18.9 4H16.4L12.9 8.3 10 4H5.1l5.2 7.4L5 20h2.5l3.8-4.7L14 20h4.9l-5.5-7.9L18.9 4zm-3 14-6-8.7L9.2 7h.9l6 8.7.7 1.3z"/>
        </svg>
      </a>
      <a class="sns-icon" href="https://www.tiktok.com/@moriris_world"
         target="_blank" rel="noopener noreferrer" aria-label="TikTok">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M18.5 7.3a4.4 4.4 0 0 1-2.7-1V14a4.9 4.9 0 1 1-4.9-4.9 5 5 0 0 1 1 .1v2.1a2.8 2.8 0 0 0-1-.2 2.8 2.8 0 1 0 2.8 2.8V3.9h2.2a4.4 4.4 0 0 0 2.6 2.5z"/>
        </svg>
      </a>
    </div>
    <div data-i18n="footer_note">
      æœ€æ–°æƒ…å ±ã¯å„ç¨®SNSã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚
    </div>
    <div id="legalLinks" style="margin-top:4px;font-size:11px;"></div>
  </footer>
</div>

<!-- åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ç”¨ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="pwOverlay" class="pw-overlay hidden">
  <div class="pw-card">
    <h2 data-i18n="pw_setup_title">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¨­å®š</h2>
    <p class="muted" data-i18n="pw_setup_desc">
      åˆå›ç™»éŒ²ã§ã¯ãƒ¡ãƒ¼ãƒ«èªè¨¼ã®ã¿ã§ã—ãŸã€‚ä»Šå¾Œã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã€ã“ã“ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
    </p>

    <form id="pwForm" style="margin-top:8px;display:flex;flex-direction:column;gap:8px;max-width:420px;">
      <div class="pw-input-wrap">
        <input
          id="pwNew"
          type="password"
          class="input"
          placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰"
          data-i18n-placeholder="pw_placeholder_new"
        />
        <button type="button" id="pwNewToggle" class="pw-eye-btn" aria-label="Toggle password">ğŸ‘</button>
      </div>
      <div class="pw-input-wrap">
        <input
          id="pwNew2"
          type="password"
          class="input"
          placeholder="ç¢ºèªã®ãŸã‚ã€åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚‚ã†ä¸€åº¦"
          data-i18n-placeholder="pw_placeholder_confirm"
        />
        <button type="button" id="pwNew2Toggle" class="pw-eye-btn" aria-label="Toggle password">ğŸ‘</button>
      </div>
      <button type="submit" class="btn btn-outline" data-i18n="pw_setup_btn">
        ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹
      </button>
    </form>

    <p id="pwMsg" class="muted" style="font-size:12px;margin-top:6px;"></p>
  </div>
</div>
  
<script>
  const SUPABASE_URL = "https://sqwyfscumunyhsvsvejv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxd3lmc2N1bXVueWhzdnN2ZWp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODM4NDQsImV4cCI6MjA3NzA1OTg0NH0.P_6eP5E_Du82IEI1gzn4PKQjnqlVGoptmZZR9aIiXNU";

  const SITE_TOP_URL = "https://member.moriris.com/";

  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth:{ persistSession:true, autoRefreshToken:true, storageKey:"moriris-auth" }
  });

  const PRICE_ID_STANDARD = "price_1SZ4pbJBnnPY5Sg2uplAWUVc";

  const $ = (s)=>document.querySelector(s);
  const debugOn = new URL(location.href).searchParams.get("debug")==="1";
  const log = (...a)=>{ if(!debugOn) return; const el=$("#dbg"); el.classList.remove("hidden");
    el.textContent += a.map(x=>typeof x==="string"?x:JSON.stringify(x,null,2)).join(" ") + "\n"; };

  // â˜… ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šæ¸ˆã¿ãƒ•ãƒ©ã‚°ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å´ï¼‰
  const pwLocalKeyBase = "moriris_pw_done_";

  const I18N = {
    ja:{
      brand_meta:"MEMBERSHIP",
      logged_in_label:"ãƒ­ã‚°ã‚¤ãƒ³ä¸­ï¼š",
      logout:"ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ",
      tab_home:"HOME",
      tab_animation:"ANIMATION",
      tab_book:"PICTUREBOOK",
      tab_account:"ACCOUNT",
      home_title:"ã‚ˆã†ã“ãã€ãƒ¢ãƒªãƒªã‚¹ãƒ¡ãƒ³ãƒãƒ¼ã‚ºã¸",
      home_intro:"ãƒ¡ãƒ³ãƒãƒ¼é™å®šã®ã‚¢ãƒ‹ãƒ¡ã‚„ãƒ‡ã‚¸ã‚¿ãƒ«çµµæœ¬ã‚’ã€ã“ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰ãŠæ¥½ã—ã¿ã„ãŸã ã‘ã¾ã™ã€‚",
      home_how_title:"ãƒ¡ãƒ³ãƒãƒ¼ã‚¨ãƒªã‚¢ã®æ¥½ã—ã¿æ–¹",
      home_how_1:"ANIMATIONã‚¿ãƒ–ã‹ã‚‰ãƒ¡ãƒ³ãƒãƒ¼é™å®šã‚¢ãƒ‹ãƒ¡ã‚’è¦–è´ã§ãã¾ã™ã€‚",
      home_how_2:"PICTUREBOOKã‚¿ãƒ–ã‹ã‚‰ãƒ‡ã‚¸ã‚¿ãƒ«çµµæœ¬ã‚„é–¢é€£ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’èª­ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚",
      home_how_3:"ãƒ—ãƒ©ãƒ³ã®ç¢ºèªã‚„å¤‰æ›´ã¯ ACCOUNTã‚¿ãƒ–ã‹ã‚‰ã„ã¤ã§ã‚‚è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚",
      account_title:"ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ»ãƒ—ãƒ©ãƒ³æƒ…å ±",
      account_intro:"ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚„ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ãƒ»è§£ç´„ã¯ã€ã“ã®ãƒšãƒ¼ã‚¸ã‹ã‚‰è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚",
      plan_label:"ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ï¼š",
      plan_free:"Free",
      plan_standard:"Standard",
      status_checking:"ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™â€¦",
      status_not_logged:"æœªãƒ­ã‚°ã‚¤ãƒ³ã‹ã€ãƒ–ãƒ©ã‚¦ã‚¶ãŒå¤‰ã‚ã£ãŸãŸã‚ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãƒ­ã‚°ã‚¤ãƒ³ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚",
      status_free:"ãŸã ã„ã¾æœ‰åŠ¹ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
      status_loading:"å‹•ç”»ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦",
      status_ready:"ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ãŠæ¥½ã—ã¿ãã ã•ã„ã€‚",
      status_error:"æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚",
      btn_subscribe:"Standardãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã™ã‚‹",
      btn_cancel:"ã‚µãƒ–ã‚¹ã‚¯ã‚’è§£ç´„ã™ã‚‹",
      btn_delete:"ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã™ã‚‹",
      delete_confirm:"æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚",
      delete_done:"ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ã”åˆ©ç”¨ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚",
      delete_error:"ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
      anim_title:"ãƒ¡ãƒ³ãƒãƒ¼é™å®šã‚¢ãƒ‹ãƒ¡",
      anim_gate_free:"Standard ãƒ—ãƒ©ãƒ³ã«ç™»éŒ²ã„ãŸã ãã¨ã€ã™ã¹ã¦ã®ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ãŒè¦–è´å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚",
      anim_gate_std:"ãƒ¡ãƒ³ãƒãƒ¼é™å®šã‚¢ãƒ‹ãƒ¡ã‚’ãŠæ¥½ã—ã¿ã„ãŸã ã‘ã¾ã™ã€‚",
      anim_empty:"ç¾åœ¨ã€è¦–è´å¯èƒ½ãªå‹•ç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚",
      video_sort_label:"è¡¨ç¤ºé †ï¼š",
      video_sort_episode:"ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é †",
      video_sort_new:"æ–°ç€é †",
      book_title:"ãƒ‡ã‚¸ã‚¿ãƒ«çµµæœ¬",
      book_intro_free:"ãƒ‡ã‚¸ã‚¿ãƒ«çµµæœ¬ã®é–²è¦§ã¯ Standard ãƒ—ãƒ©ãƒ³ç™»éŒ²å¾Œã«ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚",
      book_intro_std:"ãƒ¢ãƒªãƒªã‚¹ã®ä¸–ç•Œã‚’çµµæœ¬ã§ã‚‚ãŠæ¥½ã—ã¿ã„ãŸã ã‘ã¾ã™ã€‚",
      book_ep1_title:"Moriris Picture Book â€“ Episode 1",
      book_ep2_title:"Moriris Picture Book â€“ Episode 2",
      book_common_desc:"æ£®ã§å§‹ã¾ã‚‹å°ã•ãªå†’é™ºã®ç‰©èªã€‚Kindle ã‚¹ãƒˆã‚¢ã§ã‚‚ãŠèª­ã¿ã„ãŸã ã‘ã¾ã™ã€‚",
      book_kindle_link:"Kindle ã‚¹ãƒˆã‚¢ã§è¦‹ã‚‹",
      book_sort_label:"è¡¨ç¤ºé †ï¼š",
      book_sort_episode:"ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰é †",
      book_sort_new:"æ–°ç€é †",
      footer_note:"æœ€æ–°æƒ…å ±ã¯å„ç¨®SNSã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚",
      legal_note:
        '<a href="https://member.moriris.com/terms.html" target="_blank" rel="noopener">åˆ©ç”¨è¦ç´„</a> / ' +
        '<a href="https://member.moriris.com/privacy.html" target="_blank" rel="noopener">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a> / '+
        '<a href="https://member.moriris.com/legal.html" target="_blank" rel="noopener">ç‰¹å®šå•†å–å¼•æ³•ã«åŸºã¥ãè¡¨è¨˜</a>',
      email_change_title:"ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´",
      email_change_desc:"æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã™ã€‚ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å¤‰æ›´ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚",
      email_change_current:"ç¾åœ¨ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼š",
      email_change_btn:"å¤‰æ›´ç”¨ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡",
      email_change_sent:"æ–°ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å®›ã«ç¢ºèªãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‹ã‚‰å¤‰æ›´ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚",
      email_change_invalid:"æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      email_change_error:"ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
      email_change_same:"ç¾åœ¨ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨åŒã˜ã§ã™ã€‚åˆ¥ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      checkout_error:"ãŠæ‰‹ç¶šãä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
      portal_error:"ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç®¡ç†ãƒšãƒ¼ã‚¸ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",

      /* ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¨­å®šã¾ã‚ã‚Š */
      pw_setup_title:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¨­å®š",
      pw_setup_desc:"åˆå›ç™»éŒ²ã§ã¯ãƒ¡ãƒ¼ãƒ«èªè¨¼ã®ã¿ã§ã—ãŸã€‚ä»Šå¾Œã¯ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã‚ˆã†ã€ã“ã“ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚",
      pw_setup_btn:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã™ã‚‹",
      pw_setup_need_password:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      pw_setup_need_confirm:"ç¢ºèªç”¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
      pw_setup_mismatch:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚",
      pw_setup_short:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯8æ–‡å­—ä»¥ä¸Šã«ã—ã¦ãã ã•ã„ã€‚",
      pw_setup_success:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®šã—ã¾ã—ãŸã€‚æ¬¡å›ã‹ã‚‰ã¯ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚",
      pw_setup_error:"ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¨­å®šä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚",
      pw_placeholder_new:"æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šï¼‰",
      pw_placeholder_confirm:"ç¢ºèªã®ãŸã‚ã€åŒã˜ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã‚‚ã†ä¸€åº¦"
    },
    en:{
      brand_meta:"MEMBERSHIP",
      logged_in_label:"Logged in as",
      logout:"Logout",
      tab_home:"HOME",
      tab_animation:"ANIMATION",
      tab_book:"PICTUREBOOK",
      tab_account:"ACCOUNT",
      home_title:"Welcome to MORIRIS MEMBERSHIP",
      home_intro:"Enjoy members-only animations and digital picture books from this page.",
      home_how_title:"How to use this area",
      home_how_1:"Watch members-only animations from the ANIMATION tab.",
      home_how_2:"Read digital picture books and extras from the PICTUREBOOK tab.",
      home_how_3:"You can check or change your plan anytime from the ACCOUNT tab.",
      account_title:"Account & Plan",
      account_intro:"Check your current plan, subscribe, or cancel from this page.",
      plan_label:"Current plan:",
      plan_free:"Free",
      plan_standard:"Standard",
      status_checking:"Checking your login statusâ€¦",
      status_not_logged:"You are not logged in, or we couldnâ€™t restore your login session (for example, if the link was opened in a different browser). Please log in again.",
      status_free:"You don't have an active subscription yet.",
      status_loading:"Loading videosâ€¦",
      status_ready:"Enjoy the content!",
      status_error:"Failed to load your membership information.",
      btn_subscribe:"Subscribe to Standard plan",
      btn_cancel:"Cancel subscription",
      btn_delete:"Delete account",
      delete_confirm:"Are you sure you want to delete your account? This action cannot be undone.",
      delete_done:"Your account has been deleted. Thank you for using Moriris.",
      delete_error:"An error occurred while deleting your account. Please try again later.",
      anim_title:"Members-only Animation",
      anim_gate_free:"By subscribing to the Standard plan, you can watch all episodes.",
      anim_gate_std:"You can now watch all members-only episodes.",
      anim_empty:"There are no videos available yet.",
      video_sort_label:"Order:",
      video_sort_episode:"By episode",
      video_sort_new:"Newest first",
      book_title:"Digital Picture Books",
      book_intro_free:"Digital picture books are available with the Standard plan.",
      book_intro_std:"Enjoy the world of Moriris as picture books.",
      book_ep1_title:"Moriris Picture Book â€“ Episode 1",
      book_ep2_title:"Moriris Picture Book â€“ Episode 2",
      book_common_desc:"A small adventure that begins in the forest. Also available on Kindle.",
      book_kindle_link:"View on Kindle Store",
      book_sort_label:"Order:",
      book_sort_episode:"By episode",
      book_sort_new:"Newest first",
      footer_note:"Follow Moriris on social media for the latest updates.",
      legal_note:
        '<a href="https://member.moriris.com/terms.html" target="_blank" rel="noopener">Terms of Service</a> / ' +
        '<a href="https://member.moriris.com/privacy.html" target="_blank" rel="noopener">Privacy Policy</a> / '+
        '<a href="https://member.moriris.com/legal.html" target="_blank" rel="noopener">Legal Notice</a>',
      email_change_title:"Change Email Address",
      email_change_desc:"Enter a new email address and we will send a confirmation email. Please use the link in that email to complete the change.",
      email_change_current:"Current email:",
      email_change_btn:"Send confirmation email",
      email_change_sent:"Weâ€™ve sent a confirmation email to your new address. Please follow the link in the email to complete the change.",
      email_change_invalid:"Please enter a valid email address.",
      email_change_error:"An error occurred while changing your email. Please try again later.",
      email_change_same:"This is the same as your current email. Please enter a different address.",
      checkout_error:"Something went wrong while processing your request. Please try again later.",
      portal_error:"We couldnâ€™t open the subscription management page. Please try again later.",

      /* password setup */
      pw_setup_title:"Set your password",
      pw_setup_desc:"You initially registered with email verification only. To log in with your email and password from now on, please set a password here.",
      pw_setup_btn:"Set password",
      pw_setup_need_password:"Please enter a password.",
      pw_setup_need_confirm:"Please enter the confirmation password.",
      pw_setup_mismatch:"The passwords do not match.",
      pw_setup_short:"Please use at least 8 characters for the password.",
      pw_setup_success:"Your password has been set. Next time, log in using your email and password on the login page.",
      pw_setup_error:"An error occurred while setting your password. Please try again later.",
      pw_placeholder_new:"New password (8+ characters)",
      pw_placeholder_confirm:"Re-enter the same password"
    }
  };

  let currentLang = "ja";
  const langKey = "moriris_lang_members";
  const state = {
    plan:"free",
    statusCode:"checking",
    hasPassword:false
  };

  let currentUser = null;

  const BOOK_EP1_IMAGES = [
    "/assets/book-ep1/1.png","/assets/book-ep1/2.png","/assets/book-ep1/3.png",
    "/assets/book-ep1/4.png","/assets/book-ep1/5.png","/assets/book-ep1/6.png",
    "/assets/book-ep1/7.png","/assets/book-ep1/8.png","/assets/book-ep1/9.png",
    "/assets/book-ep1/10.png","/assets/book-ep1/11.png","/assets/book-ep1/12.png",
    "/assets/book-ep1/13.png","/assets/book-ep1/14.png","/assets/book-ep1/15.png"
  ];
  const BOOK_EP2_IMAGES = [
    "/assets/book-ep2/1.png","/assets/book-ep2/2.png","/assets/book-ep2/3.png",
    "/assets/book-ep2/4.png","/assets/book-ep2/5.png","/assets/book-ep2/6.png",
    "/assets/book-ep2/7.png","/assets/book-ep2/8.png","/assets/book-ep2/9.png",
    "/assets/book-ep2/10.png","/assets/book-ep2/11.png","/assets/book-ep2/12.png",
    "/assets/book-ep2/13.png","/assets/book-ep2/14.png"
  ];

  const bookState = {
    ep1Index:0,
    ep2Index:0
  };

  const VIDEO_JSON_URL = "/data/video.json";
  let VIDEO_EPISODES = [];
  let videoSortMode = "episode";

  async function loadVideoEpisodes(){
    try{
      const res = await fetch(VIDEO_JSON_URL);
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      VIDEO_EPISODES = Array.isArray(data)
        ? data.filter(ep => !Object.prototype.hasOwnProperty.call(ep, "visible") || ep.visible !== false)
        : [];
      log("video json loaded", VIDEO_EPISODES);
    }catch(e){
      console.error("video json load error", e);
      VIDEO_EPISODES = [];
    }
  }

  function updateBookViewer(bookKey){
    let images, idx, imgId, indicatorId;

    if (bookKey === "ep1"){
      images = BOOK_EP1_IMAGES;
      idx = bookState.ep1Index;
      imgId = "bookEp1Image";
      indicatorId = "bookEp1PageIndicator";
    }else if (bookKey === "ep2"){
      images = BOOK_EP2_IMAGES;
      idx = bookState.ep2Index;
      imgId = "bookEp2Image";
      indicatorId = "bookEp2PageIndicator";
    }else{
      return;
    }
    if (!images || !images.length) return;

    const img = document.getElementById(imgId);
    const indicator = document.getElementById(indicatorId);
    if (!img || !indicator) return;

    img.src = images[idx];
    indicator.textContent = (idx + 1) + " / " + images.length;
  }

  function applyLang(lang){
    currentLang = lang;
    localStorage.setItem(langKey, lang);
    document.documentElement.lang = lang;

    const t = I18N[lang];

    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      if (t[key]) el.textContent = t[key];
    });

    document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
      const key = el.getAttribute("data-i18n-placeholder");
      if (t[key]) el.placeholder = t[key];
    });

    const legal = document.getElementById("legalLinks");
    if (legal && t.legal_note){
      legal.innerHTML = t.legal_note;
    }

    const planLabelText = $("#planLabelText");
    if (planLabelText){
      const planKey = state.plan === "standard" ? "plan_standard" : "plan_free";
      planLabelText.textContent = t[planKey];
    }

    const statusEl = $("#statusText");
    if (statusEl){
      const map = {
        checking:"status_checking",
        not_logged:"status_not_logged",
        free:"status_free",
        loading:"status_loading",
        ready:"status_ready",
        error:"status_error"
      };
      const k = map[state.statusCode] || "status_error";
      statusEl.textContent = t[k];
    }

    const animGate = $("#animGateText");
    if (animGate){
      animGate.textContent = state.plan === "standard"
        ? t.anim_gate_std
        : t.anim_gate_free;
    }

    const bookIntro = $("#bookIntro");
    if (bookIntro){
      bookIntro.textContent = state.plan === "standard"
        ? t.book_intro_std
        : t.book_intro_free;
    }

    const bookList = $("#bookList");
    const bookSortRow = $("#bookSortRow");
    const bookCommonMeta = $("#bookCommonMeta");
    
    if (bookList){
      if (state.plan === "standard"){
        bookList.classList.remove("hidden");
        bookSortRow.classList.remove("hidden");
      }else{
        bookList.classList.add("hidden");
        bookSortRow.classList.add("hidden");
      }
      bookCommonMeta.classList.remove("hidden");
    }

    $("#btn-ja").classList.toggle("active", lang==="ja");
    $("#btn-en").classList.toggle("active", lang==="en");
  }

  $("#btn-ja").onclick = ()=>applyLang("ja");
  $("#btn-en").onclick = ()=>applyLang("en");

  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.toggle("active", b===btn));
      document.querySelectorAll(".tab-pane").forEach(p=>{
        p.classList.toggle("active", p.id === "tab-"+tab);
      });
    });
  });

  document.addEventListener("click", (e)=>{
    const viewerBtn = e.target.closest(".book-viewer-btn");
    if (viewerBtn){
      const dir = viewerBtn.dataset.dir;
      const bookKey = viewerBtn.dataset.book;
      if (!dir || !bookKey) return;

      if (bookKey === "ep1"){
        if (dir === "prev"){
          bookState.ep1Index =
            (bookState.ep1Index - 1 + BOOK_EP1_IMAGES.length) % BOOK_EP1_IMAGES.length;
        }else{
          bookState.ep1Index =
            (bookState.ep1Index + 1) % BOOK_EP1_IMAGES.length;
        }
      }else if (bookKey === "ep2"){
        if (dir === "prev"){
          bookState.ep2Index =
            (bookState.ep2Index - 1 + BOOK_EP2_IMAGES.length) % BOOK_EP2_IMAGES.length;
        }else{
          bookState.ep2Index =
            (bookState.ep2Index + 1) % BOOK_EP2_IMAGES.length;
        }
      }
      updateBookViewer(bookKey);
      return;
    }

    const fullBtn = e.target.closest(".book-full-btn");
    if (fullBtn){
      const viewerId = fullBtn.dataset.viewer;
      if (viewerId){
        toggleBookFullscreen(viewerId);
      }
      return;
    }

    const bookSortBtn = e.target.closest(".book-sort-btn");
    if (bookSortBtn){
      const mode = bookSortBtn.dataset.sort || "episode";
      document.querySelectorAll(".book-sort-btn").forEach(b=>{
        b.classList.toggle("active", b===bookSortBtn);
      });
      sortBookEntries(mode);
      return;
    }

    const videoSortBtn = e.target.closest(".video-sort-btn");
    if (videoSortBtn){
      const mode = videoSortBtn.dataset.sort || "episode";
      document.querySelectorAll(".video-sort-btn").forEach(b=>{
        b.classList.toggle("active", b===videoSortBtn);
      });
      renderVideosForPlan(state.plan, mode);
      return;
    }
  });

  function sortBookEntries(mode){
    const list = $("#bookList");
    if (!list) return;
    const entries = Array.from(list.querySelectorAll(".book-entry"));
    entries.sort((a,b)=>{
      const ea = Number(a.dataset.ep || "0");
      const eb = Number(b.dataset.ep || "0");
      if (mode === "new"){
        return eb - ea;
      }
      return ea - eb;
    });
    entries.forEach(el=>list.appendChild(el));
  }

  function toggleBookFullscreen(viewerId){
    const el = document.getElementById(viewerId);
    if (!el) return;

    if (document.fullscreenElement === el){
      if (document.exitFullscreen){
        document.exitFullscreen();
      }else if (document.webkitExitFullscreen){
        document.webkitExitFullscreen();
      }
      return;
    }

    if (el.requestFullscreen){
      el.requestFullscreen();
    }else if (el.webkitRequestFullscreen){
      el.webkitRequestFullscreen();
    }else{
      alert("Fullscreen is not supported in this browser.");
    }
  }

  function updateFullscreenButtons(){
    const current = document.fullscreenElement;
    document.querySelectorAll(".book-full-btn").forEach(btn=>{
      const viewerId = btn.dataset.viewer;
      const img = btn.querySelector("img.book-full-icon");
      if (!img) return;
      if (current && current.id === viewerId){
        img.src = "/assets/reduction_icon.png";
        btn.title = "Exit Full Screen";
        btn.setAttribute("aria-label", "Exit Full Screen");
      }else{
        img.src = "/assets/expansion_icon.png";
        btn.title = "Full Screen";
        btn.setAttribute("aria-label", "Full Screen");
      }
    });
  }
  document.addEventListener("fullscreenchange", updateFullscreenButtons);
  document.addEventListener("webkitfullscreenchange", updateFullscreenButtons);

  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  async function getUserWithRetry({tries=40, interval=150}={}){
    try{
      await sb.auth.exchangeCodeForSession(window.location.href);
    }catch(e){ log("exchange_err", String(e)); }

    for(let i=0;i<tries;i++){
      const { data:{ user } } = await sb.auth.getUser();
      if (user) return user;
      await sleep(interval);
    }
    return null;
  }

  async function loadProfileOrCreate(userId){
    let { data:prof, error } = await sb
      .from("profiles")
      .select("id,tier,is_active,has_password")
      .eq("id", userId)
      .single();

    const notFound = error && (error.code==="PGRST116" || error.details?.includes("0 rows"));
    if (notFound){
      const up = await sb.from("profiles").upsert(
        { id:userId, tier:"free", is_active:false, has_password:false },
        { onConflict:"id" }
      );
      if (up.error){ log("profiles upsert failed", up.error); return { data:null, error:up.error }; }

      ({ data:prof, error } = await sb
        .from("profiles")
        .select("id,tier,is_active,has_password")
        .eq("id", userId)
        .single());
    }
    return { data:prof, error };
  }

  async function createCheckout(userId){
    const { data:sess } = await sb.auth.getSession();
    const token = sess?.session?.access_token;
    const i18n = I18N[currentLang] || I18N["ja"] || {};

    const res = await fetch(
      "https://sqwyfscumunyhsvsvejv.functions.supabase.co/create-checkout-session",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${token}`
        },
        body:JSON.stringify({
          user_id:userId,
          price_id:PRICE_ID_STANDARD,
          success_url:SITE_TOP_URL,
          cancel_url:SITE_TOP_URL
        })
      }
    );

    if (!res.ok){
      const bodyText = await res.text().catch(()=> "");
      console.error("createCheckout failed:", res.status, bodyText);
      alert(i18n.checkout_error || "ç¾åœ¨ã“ã®æ“ä½œã‚’å®Œäº†ã§ãã¾ã›ã‚“ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
      return;
    }
    const data = await res.json();
    if (!data?.url){
      console.error("createCheckout: url missing", data);
      alert(i18n.checkout_error || "ç¾åœ¨ã“ã®æ“ä½œã‚’å®Œäº†ã§ãã¾ã›ã‚“ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
      return;
    }
    location.href = data.url;
  }

  async function openPortal(userId){
    const { data:sess } = await sb.auth.getSession();
    const token = sess?.session?.access_token;
    const i18n = I18N[currentLang] || I18N["ja"] || {};

    const res = await fetch(
      "https://sqwyfscumunyhsvsvejv.functions.supabase.co/create-portal-session",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${token}`
        },
        body:JSON.stringify({
          user_id:userId,
          return_url:SITE_TOP_URL
        })
      }
    );

    if (!res.ok){
      const bodyText = await res.text().catch(()=> "");
      console.error("openPortal failed:", res.status, bodyText);
      alert(i18n.portal_error || "ç¾åœ¨ã“ã®æ“ä½œã‚’å®Œäº†ã§ãã¾ã›ã‚“ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
      return;
    }
    const data = await res.json();
    if (!data?.url){
      console.error("openPortal: url missing", data);
      alert(i18n.portal_error || "ç¾åœ¨ã“ã®æ“ä½œã‚’å®Œäº†ã§ãã¾ã›ã‚“ã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
      return;
    }
    location.href = data.url;
  }

  async function updateStripeEmail(userId, newEmail){
    try{
      const { data:sess } = await sb.auth.getSession();
      const token = sess?.session?.access_token;
  
      const res = await fetch(
        "https://sqwyfscumunyhsvsvejv.functions.supabase.co/update-stripe-email",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ user_id: userId, new_email: newEmail })
        }
      );
  
      if (!res.ok){
        const t = await res.text().catch(()=> "");
        console.error("updateStripeEmail failed:", res.status, t);
        return;
      }
      const data = await res.json();
      console.log("updateStripeEmail result:", data);
    }catch(e){
      console.error("updateStripeEmail error:", e);
    }
  }

  async function handleDeleteAccount() {
    if (!currentUser) return;
  
    const i18n = I18N[currentLang] || I18N["ja"] || {};
  
    const msg =
      i18n.delete_confirm ||
      "æœ¬å½“ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚";
  
    const ok = window.confirm(msg);
    if (!ok) return;
  
    try {
      const { data: sess } = await sb.auth.getSession();
      const token = sess?.session?.access_token;
      if (!token) throw new Error("no access token");
  
      const res = await fetch(
        "https://sqwyfscumunyhsvsvejv.functions.supabase.co/delete-account",
        {
          method: "POST",
          headers: {
            Authorization: `Bearer ${token}`,
          },
        },
      );
  
      if (!res.ok) {
        const bodyText = await res.text().catch(() => "");
        console.error("delete-account failed:", res.status, bodyText);
  
        const baseMsg =
          i18n.delete_error ||
          "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
  
        alert(baseMsg);
        return;
      }
  
      const doneMsg =
        i18n.delete_done || "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã«æˆ»ã‚Šã¾ã™ã€‚";
  
      alert(doneMsg);
      await sb.auth.signOut();
      location.href = "./";
    } catch (e) {
      console.error("handleDeleteAccount error:", e);
  
      const baseMsg =
        i18n.delete_error ||
        "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
  
      alert(baseMsg);
    }
  }

  function renderVideosForPlan(plan, mode = videoSortMode){
    videoSortMode = mode;
    const wrap = $("#videos");
    wrap.innerHTML = "";

    let episodes = VIDEO_EPISODES.filter(v =>
      plan === "standard" ? true : v.tier === "free"
    );

    episodes.sort((a,b)=>{
      if (mode === "new"){
        return b.ep - a.ep;
      }
      return a.ep - b.ep;
    });

    if (!episodes.length){
      const p = document.createElement("p");
      p.className = "muted";
      p.textContent = I18N[currentLang].anim_empty;
      wrap.appendChild(p);
      return;
    }

    for (const v of episodes){
      const card = document.createElement("div");
      card.className = "video-card";
      const src =
        `https://www.youtube-nocookie.com/embed/${encodeURIComponent(v.yt_id)}?rel=0&modestbranding=1&playsinline=1`;
      card.innerHTML = `
        <div style="position:relative;background:#000;aspect-ratio:16/9;">
          <iframe src="${src}" title="${v.title}" frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen loading="lazy"
            style="width:100%;height:100%;position:absolute;inset:0;"></iframe>
        </div>
        <div class="video-title">${v.title}</div>
      `;
      wrap.appendChild(card);
    }
  }

  function setupPwEyeToggle(){
    const pw1 = $("#pwNew");
    const pw2 = $("#pwNew2");
    const t1 = $("#pwNewToggle");
    const t2 = $("#pwNew2Toggle");

    if (t1 && pw1){
      t1.onclick = ()=>{
        if (pw1.type === "password"){
          pw1.type = "text";
          t1.textContent = "ğŸ™ˆ";
        }else{
          pw1.type = "password";
          t1.textContent = "ğŸ‘";
        }
      };
    }
    if (t2 && pw2){
      t2.onclick = ()=>{
        if (pw2.type === "password"){
          pw2.type = "text";
          t2.textContent = "ğŸ™ˆ";
        }else{
          pw2.type = "password";
          t2.textContent = "ğŸ‘";
        }
      };
    }
  }

  async function main(){
    const urlLang = new URL(location.href).searchParams.get("lang");
    const storedLang = localStorage.getItem(langKey);
    const navLang = (navigator.language || "ja").startsWith("ja") ? "ja" : "en";
    applyLang(urlLang || storedLang || navLang);

    updateBookViewer("ep1");
    updateBookViewer("ep2");
    updateFullscreenButtons();
    setupPwEyeToggle();

    await loadVideoEpisodes();

    state.statusCode = "checking";
    applyLang(currentLang);

    const user = await getUserWithRetry();
    if (!user){
      state.statusCode = "not_logged";
      applyLang(currentLang);
      $("#userEmail").textContent = "-";

      const alertBox = $("#notLoggedAlert");
      if (alertBox){
        alertBox.classList.remove("hidden");
        const t = I18N[currentLang] || I18N["ja"];
        const msgEl = $("#notLoggedText");
        const linkEl = $("#notLoggedLink");
        if (msgEl) msgEl.textContent = t.status_not_logged;
        if (linkEl){
          linkEl.textContent = currentLang === "ja"
            ? "ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«æˆ»ã‚‹"
            : "Back to login page";
        }
      }
      return;
    }
    currentUser = user;
    $("#userEmail").textContent = user.email || "";

    const currentEmailEl = $("#currentEmailText");
    if (currentEmailEl){
      currentEmailEl.textContent = user.email || "";
    }

    // â˜… ãƒ–ãƒ©ã‚¦ã‚¶å´ãƒ•ãƒ©ã‚°
    const localPwDone =
      localStorage.getItem(pwLocalKeyBase + user.id) === "1";

    const btnChangeEmail = $("#btnChangeEmail");
    if (btnChangeEmail){
      btnChangeEmail.onclick = async ()=>{
        const input = $("#emailNew");
        const msgEl = $("#emailChangeMsg");
        if (!input || !msgEl) return;
    
        msgEl.style.color = "#6b6964";
        const t = I18N[currentLang] || I18N["ja"];
    
        const newEmail = input.value.trim();
        const currentEmail = currentUser?.email || "";
    
        if (!newEmail){
          msgEl.textContent = t.email_change_invalid;
          msgEl.style.color = "#b00020";
          return;
        }
    
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(newEmail)){
          msgEl.textContent = t.email_change_invalid;
          msgEl.style.color = "#b00020";
          return;
        }
    
        if (newEmail.toLowerCase() === currentEmail.toLowerCase()){
          msgEl.textContent = t.email_change_same;
          msgEl.style.color = "#b00020";
          return;
        }
    
        if (!currentUser){
          msgEl.textContent = "ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
          msgEl.style.color = "#b00020";
          return;
        }
    
        btnChangeEmail.disabled = true;
        msgEl.textContent = "";
    
        try{
          const { data, error } = await sb.auth.updateUser(
            { email: newEmail },
            {
              emailRedirectTo: SITE_TOP_URL
            }
          );
    
          if (error){
            console.error("updateUser ERROR:", error);
            msgEl.textContent =
              t.email_change_error ||
              "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
            msgEl.style.color = "#b00020";
            return;
          }
    
          updateStripeEmail(currentUser.id, newEmail);
    
          msgEl.textContent = t.email_change_sent;
          msgEl.style.color = "#6b6964";
          input.value = "";
        }catch(e){
          console.error("updateUser exception:", e);
          msgEl.textContent =
            t.email_change_error ||
            "ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å¤‰æ›´ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
          msgEl.style.color = "#b00020";
        }finally{
          btnChangeEmail.disabled = false;
        }
      };
    }
    
    const profRes = await loadProfileOrCreate(user.id);
    if (profRes.error || !profRes.data){
      state.statusCode = "error";
      applyLang(currentLang);
      return;
    }

    const prof = profRes.data;
    log("profile", prof);

    // â˜… Supabaseï¼‹ãƒ–ãƒ©ã‚¦ã‚¶ã®ä¸¡æ–¹ã‚’è¦‹ã¦åˆ¤å®š
    state.hasPassword = (prof.has_password === true) || localPwDone;

    const pwOverlay = $("#pwOverlay");
    const pwForm = $("#pwForm");
    const pwMsg = $("#pwMsg");

    if (pwOverlay){
      if (state.hasPassword){
        pwOverlay.classList.add("hidden");
      }else{
        pwOverlay.classList.remove("hidden");
      }
    }

    if (pwForm){
      pwForm.onsubmit = async (e)=>{
        e.preventDefault();
        if (!currentUser) return;

        const t = I18N[currentLang] || I18N["ja"];
        if (pwMsg){
          pwMsg.textContent = "";
          pwMsg.style.color = "#6b6964";
        }

        const p1 = $("#pwNew")?.value || "";
        const p2 = $("#pwNew2")?.value || "";

        if (!p1){
          if (pwMsg){
            pwMsg.textContent = t.pw_setup_need_password;
            pwMsg.style.color = "#b00020";
          }
          return;
        }
        if (!p2){
          if (pwMsg){
            pwMsg.textContent = t.pw_setup_need_confirm;
            pwMsg.style.color = "#b00020";
          }
          return;
        }
        if (p1 !== p2){
          if (pwMsg){
            pwMsg.textContent = t.pw_setup_mismatch;
            pwMsg.style.color = "#b00020";
          }
          return;
        }
        if (p1.length < 8){
          if (pwMsg){
            pwMsg.textContent = t.pw_setup_short;
            pwMsg.style.color = "#b00020";
          }
          return;
        }

        const btn = pwForm.querySelector("button[type='submit']");
        if (btn) btn.disabled = true;

        try{
          const { error:updateErr } = await sb.auth.updateUser({ password:p1 });
          if (updateErr){
            console.error("updateUser(password) error:", updateErr);
            if (pwMsg){
              pwMsg.textContent = t.pw_setup_error;
              pwMsg.style.color = "#b00020";
            }
            return;
          }

          const { error:profErr } = await sb
            .from("profiles")
            .update({ has_password:true })
            .eq("id", currentUser.id);
          if (profErr){
            console.error("profiles update has_password error:", profErr);
          }

          // â˜… ãƒ–ãƒ©ã‚¦ã‚¶å´ãƒ•ãƒ©ã‚°ã‚‚ç«‹ã¦ã‚‹
          localStorage.setItem(pwLocalKeyBase + currentUser.id, "1");
          state.hasPassword = true;

          if (pwMsg){
            pwMsg.textContent = t.pw_setup_success;
            pwMsg.style.color = "#6b6964";
          }

          if (pwOverlay){
            setTimeout(()=>pwOverlay.classList.add("hidden"), 800);
          }
        }catch(err){
          console.error("password setup exception:", err);
          if (pwMsg){
            pwMsg.textContent = t.pw_setup_error;
            pwMsg.style.color = "#b00020";
          }
        }finally{
          if (btn) btn.disabled = false;
        }
      };
    }

    const tier = (prof.tier || "free").toLowerCase();
    const isActive = !!prof.is_active;

    if (!isActive || tier==="free"){
      state.plan = "free";
      state.statusCode = "free";
      applyLang(currentLang);
    
      const btnSubMain  = $("#btnSubscribe");
      const btnSubAnim  = $("#btnSubscribeAnim");
      const btnSubBook  = $("#btnSubscribeBook");
      const btnCancel   = $("#btnCancel");
      const btnDelete   = $("#btnDeleteAccount");
    
      [btnSubMain, btnSubAnim, btnSubBook].forEach(b=>{
        if (!b) return;
        b.classList.remove("hidden");
        b.onclick = ()=>createCheckout(user.id);
      });
      if (btnCancel){
        btnCancel.classList.add("hidden");
        btnCancel.onclick = null;
      }
      if (btnDelete){
        btnDelete.classList.remove("hidden");
        btnDelete.onclick = handleDeleteAccount;
      }
    
      renderVideosForPlan("free", videoSortMode);
    }else{
      state.plan = "standard";
      state.statusCode = "loading";
      applyLang(currentLang);
    
      const btnSubMain  = $("#btnSubscribe");
      const btnSubAnim  = $("#btnSubscribeAnim");
      const btnSubBook  = $("#btnSubscribeBook");
      const btnCancel   = $("#btnCancel");
      const btnDelete   = $("#btnDeleteAccount");
    
      [btnSubMain, btnSubAnim, btnSubBook].forEach(b=>{
        if (!b) return;
        b.classList.add("hidden");
        b.onclick = null;
      });
      if (btnCancel){
        btnCancel.classList.remove("hidden");
        btnCancel.onclick = ()=>openPortal(user.id);
      }
      if (btnDelete){
        btnDelete.classList.add("hidden");
        btnDelete.onclick = null;
      }
    
      renderVideosForPlan("standard", videoSortMode);
    
      state.statusCode = "ready";
      applyLang(currentLang);
    
      sortBookEntries("episode");
    }

    $("#logout").onclick = async ()=>{
      try{ await sb.auth.signOut(); }catch{}
      location.replace("./");
    };
  }

  main();
</script>
</body>
</html>
