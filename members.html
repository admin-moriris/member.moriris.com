// members.html 内のスクリプトに追加 or 置換
async function waitProfileActive(userId, {tries=20, interval=1500} = {}) {
  for (let i=0; i<tries; i++) {
    const { data, error } = await sb.from('profiles').select('is_active,tier').eq('id', userId).single();
    if (!error && data && data.is_active) return data;
    await new Promise(r=>setTimeout(r, interval));
  }
  return null;
}

(async () => {
  // ...既存の getUserWithRetry() で user を取得済みとする
  const params = new URL(location.href).searchParams;
  const success = params.get('success') === '1' || !!params.get('session_id');

  let prof = await sb.from('profiles').select('is_active,tier').eq('id', user.id).single();

  if (success && (!prof.data?.is_active)) {
    // 反映待ち
    const waited = await waitProfileActive(user.id);
    if (waited) prof = { data: waited, error: null };
  }

  if (!prof.error && prof.data?.is_active) {
    // 会員向けUIを表示（あなたの既存ロジックでOK）
  } else {
    // まだ未反映なら購読ブロックを表示
  }
})();
