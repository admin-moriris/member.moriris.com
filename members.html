<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>

  <!-- Google tag (gtag.js)  -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HWRX6Q9K3E"></script>
  <script>
    const isDebug = new URLSearchParams(location.search).get('debug') === '1';
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-HWRX6Q9K3E', {
      debug_mode: isDebug,
      linker: { domains: ['official.moriris.com', 'member.moriris.com'] }
    });
  </script>

  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Moriris Video Platform for Facilities</title>

  <style>
    :root{
      --bg:#faf8f4;
      --panel:#ffffff;
      --ink:#24311c;
      --muted:#6b6964;
      --accent:#75c29c;
      --accent-dark:#0b5130;
      --radius:20px;
      --shadow:0 10px 32px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box;}
    html,body{ margin:0; height:100%; }
    body{
      min-height:100vh;
      background-color:#faf8f4;
      background-image:url("/assets/hero-forest.png");
      background-repeat:no-repeat;
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
    }
    .page{ max-width:1120px; margin:0 auto; padding:0 18px 32px; }

    .header-wrap{
      position:sticky; top:0; z-index:100;
      padding-bottom:10px;
      background: linear-gradient(to bottom, rgba(250,248,244,1) 0%, rgba(250,248,244,.95) 70%, rgba(250,248,244,0) 100%);
      backdrop-filter:blur(4px);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }
    .brand{ display:flex; align-items:center; gap:18px; }
    .brand img{
      max-width:220px;
      height:auto;
      display:block;
      filter:drop-shadow(0 4px 12px rgba(0,0,0,.18));
    }
    .brand-title{ display:flex; align-items:center; }
    .brand-title span{
      font-size:20px;
      letter-spacing:.22em;
      text-transform:none;
      color:#666666;
      font-weight:500;
      white-space:nowrap;
    }
    @media (max-width: 860px){
      .brand-title span{
        white-space:normal;  /* 折り返し許可 */
        line-height:1.2;
        letter-spacing:0.06em;
        font-size:18px;
      }
    }

    .lang{ display:flex; gap:8px; align-items:center; }
    .lang button{
      border:1px solid #ddd;
      background:#fff;
      border-radius:999px;
      padding:6px 12px;
      cursor:pointer;
      font-size:13px;
    }
    .lang .active{
      border-color:var(--accent);
      color:var(--accent-dark);
      font-weight:600;
    }

    .pw-banner{
      background:#ffe7e3;
      border:1px solid #ffb3a7;
      color:#8b1a07;
      border-radius:12px;
      padding:10px 14px;
      margin-bottom:16px;
      font-size:14px;
      font-weight:600;
      cursor:pointer;
    }

    .user-box{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:13px;
      color:var(--muted);
      justify-content:flex-end;
    }
    .pill{
      border-radius:999px;
      background:#ffffff;
      padding:4px 10px;
      border:1px solid rgba(0,0,0,.08);
    }
    .btn{
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      padding:7px 12px;
      cursor:pointer;
      font-size:13px;
      color:var(--ink);
      user-select:none;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .btn-primary{
      background:var(--accent);
      border-color:transparent;
      color:var(--accent-dark);
      font-weight:600;
    }
    .btn-outline{ background:#fff; color:var(--ink); }
    .btn-danger{
      background:#ffe7e3;
      border-color:#ffb3a7;
      color:#8b1a07;
      font-weight:600;
    }
    .input{
      border-radius:999px;
      border:1px solid #ddd;
      background:#fff;
      padding:7px 10px;
      font-size:13px;
      min-width:220px;
    }

    .tabs{
      margin-top:8px;
      background:rgba(255,255,255,.95);
      border-radius:999px;
      box-shadow:0 4px 18px rgba(0,0,0,.08);
      padding:4px;
      display:flex;
      gap:4px;
      overflow:auto;
    }
    .tab-btn{
      flex:1;
      min-width:0;
      border:none;
      background:transparent;
      border-radius:999px;
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
      letter-spacing:.12em;
    }
    .tab-btn.active{
      background:var(--accent);
      color:var(--accent-dark);
      font-weight:600;
    }
    .add-gap { margin-bottom: 20px; }

    main{ margin-top:40px; }
    .card{
      background:var(--panel);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:20px 20px 24px;
      margin-bottom:18px;
    }
    .tab-pane{display:none;}
    .tab-pane.active{display:block;}

    h2{ margin:0 0 10px; font-size:20px; }
    h3{ margin:0 0 6px; font-size:16px; }
    p{ margin:6px 0; line-height:1.7; font-size:14px; }
    .muted{color:var(--muted);}

    .home-layout{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    .status-box{
      background:#f5ffe9;
      border-radius:16px;
      padding:12px 14px;
      font-size:13px;
      margin-top:8px;
      border:1px solid #d7e8c4;
    }
    .cta-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
      align-items:center;
    }

    /* ===== Videos ===== */

    .video-grid{ margin-top:12px; }

    /* 表示形式（list / grid） */
    .video-grid.mode-list{
      display:flex;
      flex-direction:column;
      gap:22px;
    }
    .video-grid.mode-grid{
      display:grid;
      gap:14px;
      grid-template-columns:repeat(3, minmax(0, 1fr));
    }
    @media (max-width: 1024px){
      .video-grid.mode-grid{ grid-template-columns:repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 640px){
      .video-grid.mode-grid{ grid-template-columns:repeat(1, minmax(0, 1fr)); }
    }

    .video-card{
      background:var(--panel);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
      width:100%;
      max-width:none;
      margin:0;
    }

    .video-title{
      padding:10px 12px 12px;
      font-size:14px;
      font-weight:600;
    }

    .video-controls{
      margin-top:6px;
      margin-bottom:10px;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .video-controls .label{
      font-size:12px;
      color:var(--muted);
    }
    .video-sort-btn, .chip, .view-btn{
      border-radius:999px;
      border:1px solid #ccc;
      background:#fff;
      padding:4px 10px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .video-sort-btn.active,
    .chip.active,
    .view-btn.active{
      background:var(--accent);
      border-color:var(--accent);
      color:var(--accent-dark);
      font-weight:600;
    }

    .video-filter{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:8px;
    }

    a{color:#0d6b45;text-decoration:none;}
    a:hover{text-decoration:underline;}

    footer{
      margin-top:24px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }
    .sns-row{
      display:flex;
      justify-content:center;
      gap:16px;
      margin:10px 0 6px;
    }
    .sns-icon{
      width:40px;
      height:40px;
      border-radius:999px;
      background:#ffffff;
      box-shadow:0 4px 12px rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      text-decoration:none;
    }
    .sns-icon svg{
      width:20px;
      height:20px;
      fill:#3f6f4b;
    }

    .hidden{display:none;}

    .site-header{
      position:fixed;
      top:0; left:0; right:0;
      z-index:100;
      background: linear-gradient(to bottom, rgba(250,248,244,1) 0%, rgba(250,248,244,.95) 70%, rgba(250,248,244,0) 100%);
      backdrop-filter:blur(4px);
    }

    .main-page{ padding-top:180px; }

    @media (max-width: 768px){
      .topbar{ flex-direction:column; align-items:flex-start; gap:8px; }
      .brand{ gap:10px; }
      .brand img{ max-width:180px; }
      .brand-title span{ font-size:16px; letter-spacing:.16em; }
      .user-box{ justify-content:flex-start; flex-wrap:wrap; }
      .lang{ justify-content:flex-start; }
      .tabs{
        border-radius:16px;
        padding:4px 6px;
        gap:6px;
        -webkit-overflow-scrolling:touch;
      }
      .tab-btn{
        flex:0 0 auto;
        white-space:nowrap;
        font-size:12px;
        letter-spacing:.08em;
        padding:8px 10px;
      }
      .main-page{ padding-top:210px; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Cloudflare Stream Player SDK（loop強制用） -->
  <script src="https://embed.videodelivery.net/embed/sdk.latest.js"></script>
</head>

<body>
  <header class="site-header">
    <div class="page header-inner">
      <div class="topbar">
        <div class="brand">
          <img src="/assets/logo-moriris.png" alt="Moriris" />
          <div class="brand-title">
            <span data-i18n="brand_meta">Video Platform for Facilities</span>
          </div>
        </div>

        <div>
          <div class="user-box">
            <span data-i18n="logged_in_label">ログイン中：</span>
            <span id="userEmail" class="pill"></span>
            <button id="logout" class="btn btn-outline" data-i18n="logout">ログアウト</button>
          </div>
          <div class="lang" style="margin-top:6px;justify-content:flex-end;">
            <button id="btn-en">EN</button>
            <button id="btn-ja" class="active">JP</button>
          </div>
        </div>
      </div>

      <nav class="tabs">
        <button class="tab-btn active" data-tab="home" data-i18n="tab_home">HOME</button>
        <button class="tab-btn" data-tab="videos" data-i18n="tab_videos">VIDEOS</button>
        <button class="tab-btn" data-tab="account" data-i18n="tab_account">ACCOUNT</button>
      </nav>
    </div>
  </header>

  <div class="page main-page">
  <main>
    <!-- 未ログイン時に表示する案内 -->
    <div id="notLoggedAlert" class="card hidden" style="background:#fff7e0;border:1px solid #f3d38a;">
      <p id="notLoggedText"
         class="muted"
         style="font-size:14px;margin-bottom:8px;"
         data-i18n="status_not_logged"></p>

      <a id="notLoggedLink"
         href="./"
         style="font-size:14px;"
         data-i18n="not_logged_back_link">
        ログイン画面に戻る
      </a>
    </div>

    <!-- HOME -->
    <section id="tab-home" class="tab-pane active">
      <div class="card home-layout">
        <!-- パスワード未設定時の案内バナー -->
        <div id="pwBanner" class="pw-banner hidden" data-i18n="pw_banner_text">
          パスワードが未設定です。こちらをクリックして設定してください。
        </div>
        <div>
          <h2 data-i18n="home_title">ようこそ、モリリス 法人・施設向け視聴サイトへ</h2>
          <p class="muted" data-i18n="home_intro">
            メンバー限定の動画を、このページからお楽しみいただけます。
          </p>

          <img
            src="https://member.moriris.com/assets/home-img.png"
            alt="Moriris members home illustration"
            style="width:100%;max-width:720px;border-radius:16px;margin:16px 0;"
          />
        </div>

        <div>
          <h3 data-i18n="home_how_title">法人・施設向け視聴サイトの楽しみ方</h3>
          <ul style="margin:4px 0 0;padding-left:18px;font-size:13px;line-height:1.7;">
            <li data-i18n="home_how_1">VIDEOSタブから動画を視聴できます。</li>
            <li data-i18n="home_how_2">プランの確認や変更は ACCOUNTタブからいつでも行うことができます。</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- VIDEOS -->
    <section id="tab-videos" class="tab-pane">
      <div class="card">
        <h2 data-i18n="videos_title">メンバー限定動画</h2>
        <p class="muted" id="videoGateText">
          Standardプランに登録すると、メンバー限定の動画を視聴できます。
        </p>

        <button id="btnSubscribeVideos"
                class="btn btn-primary hidden add-gap"
                data-i18n="btn_subscribe">
          Standardプランに登録する
        </button>

        <!-- コントロール行：並び替え + 表示形式 -->
        <div class="video-controls" id="videoControlsRow">
          <span class="label" data-i18n="sort_label">並び替え：</span>
          <button type="button" class="video-sort-btn active" data-sort="newest" data-i18n="sort_newest">新しい順</button>
          <button type="button" class="video-sort-btn" data-sort="oldest" data-i18n="sort_oldest">古い順</button>

          <span class="label" style="margin-left:8px;" data-i18n="view_label">表示：</span>
          <!-- 要望：グリッド → リストの順 -->
          <button type="button" class="view-btn" data-view="grid" data-i18n="view_grid">グリッド</button>
          <button type="button" class="view-btn active" data-view="list" data-i18n="view_list">リスト</button>
        </div>

        <!-- 複数選択フィルタ -->
        <div class="video-filter" id="videoFilterRow" aria-label="Video filters"></div>

        <!-- 動画一覧 -->
        <div id="videos" class="video-grid mode-list"></div>
      </div>
    </section>

    <!-- ACCOUNT -->
    <section id="tab-account" class="tab-pane">
      <div class="card">
        <h2 data-i18n="account_title">アカウント・プラン情報</h2>
        <p class="muted" data-i18n="account_intro">
          現在のプランやサブスクリプションの変更・解約は、このページから行うことができます。
        </p>

        <div class="status-box">
          <div>
            <span data-i18n="plan_label">現在のプラン：</span>
            <span id="planLabelText">Free</span>
          </div>
          <p id="statusText" class="muted" style="margin-top:6px;">ログイン状態を確認しています…</p>
        </div>

        <div class="cta-row">
          <button id="btnSubscribe" class="btn btn-primary hidden" data-i18n="btn_subscribe">
            Standardプランに登録する
          </button>
          <button id="btnCancel" class="btn btn-danger hidden" data-i18n="btn_cancel">
            サブスクを解約する
          </button>
          <button id="btnDeleteAccount" class="btn btn-danger hidden" data-i18n="btn_delete">
            アカウントを削除する
          </button>
        </div>

        <div id="deleteConfirmBox"
             class="status-box hidden"
             style="margin-top:12px;background:#ffe7e3;border-color:#ffb3a7;color:#8b1a07;">
          <p id="deleteConfirmText" style="margin-bottom:8px;" data-i18n="delete_confirm">
            本当にアカウントを削除しますか？この操作は取り消せません。
          </p>
          <div class="cta-row">
            <button id="btnDeleteConfirm" class="btn btn-danger" data-i18n="delete_confirm_yes">はい、削除します</button>
            <button id="btnDeleteCancel" class="btn btn-outline" data-i18n="delete_confirm_no">キャンセル</button>
          </div>
          <p id="deleteStatusMsg" class="muted" style="font-size:12px;margin-top:6px;"></p>
        </div>

        <hr style="margin:18px 0;border:none;border-top:1px solid #e0e0e0;" />

        <h3 data-i18n="email_change_title">メールアドレスの変更</h3>
        <p class="muted" data-i18n="email_change_desc">
          新しいメールアドレスを入力すると、確認メールを送信します。メール内のリンクから変更を完了してください。
        </p>

        <p style="font-size:13px;margin-top:8px;">
          <span data-i18n="email_change_current">現在のメールアドレス：</span>
          <strong id="currentEmailText"></strong>
        </p>

        <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
          <input id="emailNew" type="email" class="input" placeholder="new-address@example.com" />
          <button id="btnChangeEmail" class="btn btn-outline" data-i18n="email_change_btn">変更用メールを送信</button>
        </div>

        <p id="emailChangeMsg" class="muted" style="font-size:12px;margin-top:6px;"></p>

        <hr style="margin:18px 0;border:none;border-top:1px solid #e0e0e0;" />

        <div id="pwSection" class="hidden">
          <h3 data-i18n="pw_setup_title">パスワードの設定</h3>
          <p class="muted" data-i18n="pw_setup_desc"></p>
          <small data-i18n="pw_setup_note"></small>

          <form id="pwForm" novalidate style="margin-top:10px;display:flex;flex-direction:column;gap:8px;max-width:320px;">
            <input id="pwNew"  type="password" class="input" data-i18n-placeholder="pw_placeholder_new" />
            <input id="pwNew2" type="password" class="input" data-i18n-placeholder="pw_placeholder_confirm" />
            <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">
              <input type="checkbox" id="pwShowSetup" />
              <label for="pwShowSetup" style="font-size:13px;" data-i18n="pw_show_label"></label>
            </div>
            <button id="pwSubmit" type="submit" class="btn btn-outline" data-i18n="pw_setup_btn"></button>
          </form>

          <p id="pwMsg" class="muted" style="font-size:12px;margin-top:6px;"></p>
        </div>

        <div id="pwChangeSection" class="hidden" style="margin-top:18px;">
          <h3 data-i18n="pw_change_title">パスワードの変更</h3>
          <p class="muted" data-i18n="pw_change_desc"></p>
          <small data-i18n="pw_change_note"></small>

          <form id="pwChangeForm" novalidate style="margin-top:10px;display:flex;flex-direction:column;gap:8px;max-width:320px;">
            <input id="pwChangeNew"  type="password" class="input" data-i18n-placeholder="pw_placeholder_new" />
            <input id="pwChangeNew2" type="password" class="input" data-i18n-placeholder="pw_placeholder_confirm" />
            <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">
              <input type="checkbox" id="pwShowChange" />
              <label for="pwShowChange" style="font-size:13px;" data-i18n="pw_show_label"></label>
            </div>
            <button id="pwChangeSubmit" type="submit" class="btn btn-outline" data-i18n="pw_change_btn"></button>
          </form>

          <p id="pwChangeMsg" class="muted" style="font-size:12px;margin-top:6px;"></p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="sns-row">
      <a class="sns-icon" href="https://www.youtube.com/@moriris_world" target="_blank" rel="noopener noreferrer" aria-label="YouTube">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M21.6 7.2s-.2-1.5-.8-2.1c-.7-.8-1.5-.8-1.9-.9C15.6 4 12 4 12 4s-3.6 0-6.9.2c-.4.1-1.2.1-1.9.9-.6.6-.8 2.1-.8 2.1S2 9.1 2 11v1.9c0 1.9.2 3.8.2 3.8s.2 1.5.8 2.1c.7.8 1.8.8 2.3.9 1.7.2 7 .3 7 .3s3.6 0 6.9-.2c.4-.1 1.2-.1 1.9-.9.6.6.8-2.1.8-2.1s.2-1.9.2-3.8V11c0-1.9-.2-3.8-.2-3.8zM10 9.5l4.8 2.5L10 14.5V9.5z"/>
        </svg>
      </a>
      <a class="sns-icon" href="https://x.com/moriris_world" target="_blank" rel="noopener noreferrer" aria-label="X">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M18.9 4H16.4L12.9 8.3 10 4H5.1l5.2 7.4L5 20h2.5l3.8-4.7L14 20h4.9l-5.5-7.9L18.9 4zm-3 14-6-8.7L9.2 7h.9l6 8.7.7 1.3z"/>
        </svg>
      </a>
      <a class="sns-icon" href="https://www.tiktok.com/@moriris_world_" target="_blank" rel="noopener noreferrer" aria-label="TikTok">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M18.5 7.3a4.4 4.4 0 0 1-2.7-1V14a4.9 4.9 0 1 1-4.9-4.9 5 5 0 0 1 1 .1v2.1a2.8 2.8 0 0 0-1-.2 2.8 2.8 0 1 0 2.8 2.8V3.9h2.2a4.4 4.4 0 0 0 2.6 2.5z"/>
        </svg>
      </a>
      <a class="sns-icon" href="https://www.pinterest.com/moriris_world/" target="_blank" rel="noopener noreferrer" aria-label="Pinterest">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2C6.9 2 3 5.4 3 10.2c0 3.2 1.8 5.8 4.6 6.9-.1-.6-.3-1.5 0-2.2.2-.6 1.4-5.8 1.4-5.8s-.3-.7-.3-1.6c0-1.5.9-2.6 2-2.6.9 0 1.4.7 1.4 1.6 0 1-.6 2.4-.9 3.7-.3 1.1.6 2.1 1.7 2.1 2 0 3.6-2.1 3.6-5.1 0-2.7-1.9-4.6-4.7-4.6-3.2 0-5.1 2.4-5.1 4.9 0 1 .4 2 .9 2.6.1.1.1.2.1.4-.1.4-.3 1.1-.4 1.3-.1.2-.2.3-.4.2-1.5-.7-2.4-2.9-2.4-4.7 0-3.8 2.8-7.3 8-7.3 4.2 0 7.4 3 7.4 6.9 0 4.1-2.6 7.4-6.2 7.4-1.2 0-2.3-.6-2.7-1.4l-.7 2.6c-.3 1-.9 2.3-1.3 3.1.9.3 1.8.4 2.8.4 5.1 0 9-3.4 9-8.8C21 5.6 17.1 2 12 2z"/>
        </svg>
      </a>
    </div>
    <div data-i18n="footer_note">最新情報は各種SNSでお知らせします。</div>
    <div id="legalLinks" style="margin-top:4px;font-size:11px;"></div>
  </footer>
  </div>

<script>
  const SUPABASE_URL = "https://sqwyfscumunyhsvsvejv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxd3lmc2N1bXVueWhzdnN2ZWp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODM4NDQsImV4cCI6MjA3NzA1OTg0NH0.P_6eP5E_Du82IEI1gzn4PKQjnqlVGoptmZZR9aIiXNU";

  const SITE_TOP_URL = "https://member.moriris.com/";

  const sb = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
      },
    }
  );

  const BILLING_JSON_URL = "https://member.moriris.com/data/billing.json";
  let BILLING_CONFIG = { stripe: { standard: { payment_link_url: null } } };

  const $ = (s)=>document.querySelector(s);
  const isLocal = ["localhost", "127.0.0.1"].includes(location.hostname);
  const debugOn = isLocal && new URL(location.href).searchParams.get("debug")==="1";
  if (debugOn) { gtag('set', 'debug_mode', true); }
  const log = (...a)=>{ if(!debugOn) return; console.log("[debug]", ...a); };

  function gaEvent(name, params = {}) {
    if (typeof window.gtag !== "function") return;
    window.gtag("event", name, params);
  }

  const I18N = {
    ja:{
      brand_meta:"法人・施設向け映像配信サイト",
      logged_in_label:"ログイン中：",
      logout:"ログアウト",
      tab_home:"HOME",
      tab_videos:"VIDEOS",
      tab_account:"ACCOUNT",
      status_not_logged:"未ログインか、ブラウザが変わったためログイン情報を確認できませんでした。もう一度ログインを行ってください。",
      not_logged_back_link:"ログイン画面に戻る",
      pw_banner_text:"パスワードが未設定です。こちらをクリックして設定してください。",
      home_title:"法人・施設向け映像配信サービスへようこそ",
      home_intro:"ご契約中の法人・施設向け動画を、こちらからご視聴いただけます。",
      home_how_title:"ご利用方法",
      home_how_1:"VIDEOSタブから、法人・施設向け動画をご視聴いただけます。",
      home_how_2:"プランの確認や変更は ACCOUNTタブからいつでも行うことができます。",
      account_title:"アカウント・プラン情報",
      account_intro:"現在のプランやサブスクリプションの変更・解約は、このページから行うことができます。",
      plan_label:"現在のプラン：",
      plan_free:"Free",
      plan_standard:"Standard",
      status_checking:"ログイン状態を確認しています…",
      status_free:"ただいま有効なサブスクリプションがありません。",
      status_loading:"動画を読み込み中…",
      status_ready:"コンテンツをお楽しみください。",
      status_error:"情報の取得に失敗しました。",
      btn_subscribe:"Standardプランに登録する",
      btn_cancel:"サブスクを解約する",
      btn_delete:"アカウントを削除する",
      delete_confirm:"本当にアカウントを削除しますか？この操作は取り消せません。",
      delete_confirm_yes:"はい、削除します",
      delete_confirm_no:"キャンセル",
      delete_processing:"アカウントを削除しています…",
      delete_done:"アカウントを削除しました。ご利用ありがとうございました。",
      delete_error:"アカウント削除中にエラーが発生しました。時間をおいて再度お試しください。",

      videos_title:"法人・施設向け動画",
      videos_gate_free:"Standard プランに登録いただくと、すべての動画が視聴可能になります。",
      videos_gate_std:"法人・施設でのご利用を想定した動画をご視聴いただけます。",
      videos_empty:"現在、視聴可能な動画がありません。",

      footer_note:"最新情報は各種SNSでお知らせします。",
      legal_note:
        '<a href="https://member.moriris.com/terms.html" target="_blank" rel="noopener">利用規約</a> / ' +
        '<a href="https://member.moriris.com/privacy.html" target="_blank" rel="noopener">プライバシーポリシー</a> / '+
        '<a href="https://member.moriris.com/legal.html" target="_blank" rel="noopener">特定商取引法に基づく表記</a>',

      email_change_title:"メールアドレスの変更",
      email_change_desc:"新しいメールアドレスを入力すると、確認メールを送信します。メール内のリンクから変更を完了してください。",
      email_change_current:"現在のメールアドレス：",
      email_change_btn:"変更用メールを送信",
      email_change_sent:"新しいメールアドレス宛に確認メールを送信しました。メール内のリンクから変更を完了してください。",
      email_change_invalid:"正しいメールアドレスを入力してください。",
      email_change_error:"メールアドレスの変更中にエラーが発生しました。時間をおいて再度お試しください。",
      email_change_same:"現在登録されているメールアドレスと同じです。別のメールアドレスを入力してください。",
      checkout_error:"お手続き中にエラーが発生しました。時間をおいて再度お試しください。",
      portal_error:"サブスクリプション管理ページを開けませんでした。時間をおいて再度お試しください。",

      pw_setup_title:"パスワードの設定",
      pw_setup_desc:"初回登録ではメール認証のみでした。今後はメールアドレスとパスワードでログインできるよう、ここでパスワードを設定してください。",
      pw_setup_note:"セキュリティのため、8文字以上で他サービスと使い回さないパスワードを推奨します。",
      pw_setup_btn:"パスワードを設定する",
      pw_setup_need_password:"パスワードを入力してください。",
      pw_setup_need_confirm:"確認用パスワードを入力してください。",
      pw_setup_mismatch:"パスワードが一致しません。",
      pw_setup_short:"パスワードは8文字以上にしてください。",
      pw_setup_success:"パスワードを設定しました。次回からはログイン画面でメールアドレスとパスワードをご利用ください。",
      pw_setup_error:"パスワードの設定中にエラーが発生しました。時間をおいて再度お試しください。",
      pw_placeholder_new:"新しいパスワード（8文字以上）",
      pw_placeholder_confirm:"確認のため、同じパスワードをもう一度",
      pw_show_label:"パスワードを表示する",

      pw_change_title:"パスワードの変更",
      pw_change_desc:"現在ログインしているアカウントのパスワードを変更できます。古いパスワードの入力は不要です。",
      pw_change_note:"セキュリティのため、8文字以上で他サービスと使い回さないパスワードを推奨します。",
      pw_change_btn:"パスワードを変更する",
      pw_change_success:"パスワードを変更しました。次回からは新しいパスワードでログインしてください。",

      sort_label:"並び替え：",
      sort_newest:"新しい順",
      sort_oldest:"古い順",

      view_label:"表示：",
      view_list:"リスト",
      view_grid:"グリッド",

      filter_title:"用途：",
      filter_all:"全て",
      tag_sleep:"睡眠導入",
      tag_focus:"集中",
      tag_quiet:"静かな空間"
    },
    en:{
      brand_meta:"Video Platform for Facilities",
      logged_in_label:"Logged in as",
      logout:"Logout",
      tab_home:"HOME",
      tab_videos:"VIDEOS",
      tab_account:"ACCOUNT",
      status_not_logged:"You are not logged in, or we couldn’t restore your login session (for example, if the link was opened in a different browser). Please log in again.",
      not_logged_back_link:"Back to login page",
      pw_banner_text:"You haven't set a password yet. Click here to set it.",
      home_title:"Welcome to Moriris Video Platform for Facilities",
      home_intro:"You can access videos licensed for your facility here.",
      home_how_title:"How to use this site",
      home_how_1:"Watch videos for your facility from the VIDEOS tab.",
      home_how_2:"You can check or manage your subscription from the ACCOUNT tab.",
      account_title:"Account & Plan",
      account_intro:"Check your current plan, subscribe, or cancel from this page.",
      plan_label:"Current plan:",
      plan_free:"Free",
      plan_standard:"Standard",
      status_checking:"Checking your login status…",
      status_not_logged:"You are not logged in, or we couldn’t restore your login session (for example, if the link was opened in a different browser). Please log in again.",
      status_free:"You don't have an active subscription yet.",
      status_loading:"Loading videos…",
      status_ready:"Enjoy the content!",
      status_error:"Failed to load your membership information.",
      btn_subscribe:"Subscribe to Standard plan",
      btn_cancel:"Cancel subscription",
      btn_delete:"Delete account",
      delete_confirm:"Are you sure you want to delete your account? This action cannot be undone.",
      delete_confirm_yes:"Yes, delete my account",
      delete_confirm_no:"Cancel",
      delete_processing:"Deleting your account…",
      delete_done:"Your account has been deleted. Thank you for using Moriris.",
      delete_error:"An error occurred while deleting your account. Please try again later.",

      videos_title:"Videos for Facilities",
      videos_gate_free:"By subscribing to the Standard plan, you can watch all videos.",
      videos_gate_std:"You can watch videos designed for use in facilities.",
      videos_empty:"There are no videos available yet.",

      footer_note:"Follow Moriris on social media for the latest updates.",
      legal_note:
        '<a href="https://member.moriris.com/terms.html" target="_blank" rel="noopener">Terms of Service</a> / ' +
        '<a href="https://member.moriris.com/privacy.html" target="_blank" rel="noopener">Privacy Policy</a> / '+
        '<a href="https://member.moriris.com/legal.html" target="_blank" rel="noopener">Legal Notice</a>',

      email_change_title:"Change Email Address",
      email_change_desc:"Enter a new email address and we will send a confirmation email. Please use the link in that email to complete the change.",
      email_change_current:"Current email:",
      email_change_btn:"Send confirmation email",
      email_change_sent:"We’ve sent a confirmation email to your new address. Please follow the link in the email to complete the change.",
      email_change_invalid:"Please enter a valid email address.",
      email_change_error:"An error occurred while changing your email. Please try again later.",
      email_change_same:"This is the same as your current email. Please enter a different address.",
      checkout_error:"Something went wrong while processing your request. Please try again later.",
      portal_error:"We couldn’t open the subscription management page. Please try again later.",

      pw_setup_title:"Set your password",
      pw_setup_desc:"You initially registered with email verification only. To log in with your email and password from now on, please set a password here.",
      pw_setup_note:"For security, we recommend at least 8 characters and not reusing passwords from other services.",
      pw_setup_btn:"Set password",
      pw_setup_need_password:"Please enter a password.",
      pw_setup_need_confirm:"Please enter the confirmation password.",
      pw_setup_mismatch:"The passwords do not match.",
      pw_setup_short:"Please use at least 8 characters for the password.",
      pw_setup_success:"Your password has been set. Next time, log in using your email and password on the login page.",
      pw_setup_error:"An error occurred while setting your password. Please try again later.",
      pw_placeholder_new:"New password (8+ characters)",
      pw_placeholder_confirm:"Re-enter the same password",
      pw_show_label:"Show password",

      pw_change_title:"Change password",
      pw_change_desc:"You can change the password for the account you are currently logged in with. You do not need to enter your old password.",
      pw_change_note:"For security, we recommend at least 8 characters and not reusing passwords from other services.",
      pw_change_btn:"Change password",
      pw_change_success:"Your password has been changed. Please use the new password the next time you log in.",

      sort_label:"Sort:",
      sort_newest:"Newest",
      sort_oldest:"Oldest",

      view_label:"View:",
      view_list:"List",
      view_grid:"Grid",

      filter_title:"Use:",
      filter_all:"All",
      tag_sleep:"For Sleep",
      tag_focus:"For Focus",
      tag_quiet:"Quiet Space"
    }
  };

  let currentLang = "ja";
  const langKey = "moriris_lang_members";

  const state = {
    plan: "free",
    statusCode: "checking",
    hasPassword: false
  };

  let currentUser = null;

  // JSON
  const VIDEO_JSON_URL = "https://member.moriris.com/data/video.json";
  let VIDEO_CONFIG = { cloudflare:null, episodes:[] };

  // sort/view/filter state
  let videoSortMode = "newest"; // newest | oldest
  let viewMode = "list";        // list | grid
  const selectedTags = new Set(); // sleep/focus/quiet
  const FIXED_TAGS = ["sleep","focus","quiet"]; // 要望：この3つ

  function tagLabel(tag){
    const t = I18N[currentLang] || I18N["ja"];
    if (tag === "__all__") return t.filter_all || "All";
    const key = `tag_${tag}`;
    return t[key] || tag;
  }

  function applyViewMode(mode){
    viewMode = mode;
    localStorage.setItem("moriris_view_mode", mode);

    const wrap = document.getElementById("videos");
    if (wrap){
      wrap.classList.toggle("mode-list", mode === "list");
      wrap.classList.toggle("mode-grid", mode === "grid");
    }

    document.querySelectorAll(".view-btn").forEach(b=>{
      b.classList.toggle("active", b.dataset.view === mode);
    });
  }
  
  async function loadVideoConfig(){
    try{
      const res = await fetch(VIDEO_JSON_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      const cloudflare = data?.cloudflare || null;
      const episodesRaw = Array.isArray(data?.episodes) ? data.episodes : [];
      const episodes = episodesRaw.filter(v => v && (v.visible !== false));

      VIDEO_CONFIG = { cloudflare, episodes };
      log("video json loaded", VIDEO_CONFIG);

      renderTagFilterUI();
    }catch(e){
      console.error("video json load error", e);
      VIDEO_CONFIG = { cloudflare:null, episodes:[] };
      renderTagFilterUI();
    }
  }

  async function loadBillingConfig(){
    try{
      const res = await fetch(BILLING_JSON_URL, { cache: "no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      BILLING_CONFIG = data || BILLING_CONFIG;
      log("billing json loaded", BILLING_CONFIG);
    }catch(e){
      console.error("billing json load error", e);
      BILLING_CONFIG = { stripe: { standard: { payment_link_url: null } } };
    }
  }

  function renderTagFilterUI(){
    const row = document.getElementById("videoFilterRow");
    if (!row) return;

    const t = I18N[currentLang] || I18N["ja"];
    row.innerHTML = "";
    row.classList.remove("hidden");

    const title = document.createElement("span");
    title.className = "muted";
    title.style.fontSize = "12px";
    title.textContent = t.filter_title || "Filter:";
    row.appendChild(title);

    // 「全て」：左端。押すと selectedTags を空にする
    const allBtn = document.createElement("button");
    allBtn.type = "button";
    allBtn.className = "chip";
    allBtn.textContent = tagLabel("__all__");
    allBtn.dataset.tag = "__all__";
    allBtn.classList.toggle("active", selectedTags.size === 0);
    allBtn.addEventListener("click", ()=>{
      selectedTags.clear();
      gaEvent("video_filter_all", { plan: state.plan, lang: currentLang });
      renderTagFilterUI();
      renderVideosForPlan(state.plan, videoSortMode);
    });
    row.appendChild(allBtn);

    // 固定タグ（sleep / focus / quiet）
    const makeChip = (tag)=>{
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "chip";
      btn.textContent = tagLabel(tag);
      btn.dataset.tag = tag;
      btn.classList.toggle("active", selectedTags.has(tag));
      btn.addEventListener("click", ()=>{
        if (selectedTags.has(tag)) selectedTags.delete(tag);
        else selectedTags.add(tag);

        gaEvent("video_filter_toggle", {
          tag,
          active: selectedTags.has(tag) ? 1 : 0,
          plan: state.plan,
          lang: currentLang
        });

        renderTagFilterUI(); // 「全て」active制御のため再描画
        renderVideosForPlan(state.plan, videoSortMode);
      });
      return btn;
    };

    FIXED_TAGS.forEach(tag => row.appendChild(makeChip(tag)));
  }

  function getTitle(v){
    if (v?.title && typeof v.title === "object"){
      return (v.title[currentLang] || v.title["en"] || v.title["ja"] || "").trim();
    }
    return String(v?.title || "").trim();
  }

  function toTime(v){
    const s = v?.published_at;
    const n = Date.parse(s);
    return Number.isFinite(n) ? n : 0;
  }

  function matchSelectedTags(v){
    if (selectedTags.size === 0) return true; // 「全て」
    const tags = Array.isArray(v.tags) ? v.tags : [];
    for (const t of selectedTags){
      if (tags.includes(t)) return true; // OR条件
    }
    return false;
  }

  function buildCloudflareIframeSrc(cf, uid){
    const customer = cf?.customer_code;
    if (!customer || !uid) return null;

    // ここで「loop/autoplay/muted」を確実に含める（JSON側に無くても効くように）
    const baseParams = new URLSearchParams(cf?.iframe_params || "");
    if (!baseParams.has("loop")) baseParams.set("loop", "true");
    if (!baseParams.has("controls")) baseParams.set("controls", "true");
    baseParams.set("autoplay", "false");

    const qp = baseParams.toString() ? `?${baseParams.toString()}` : "";
    return `https://${customer}/${encodeURIComponent(uid)}/iframe${qp}`;
  }

  function applyLang(lang){
    currentLang = lang;
    localStorage.setItem(langKey, lang);
    document.documentElement.lang = lang;

    const t = I18N[lang];

    document.querySelectorAll("[data-i18n]").forEach(el=>{
      const key = el.getAttribute("data-i18n");
      if (t[key]) el.textContent = t[key];
    });

    document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
      const key = el.getAttribute("data-i18n-placeholder");
      if (t[key]) el.placeholder = t[key];
    });

    const legal = document.getElementById("legalLinks");
    if (legal && t.legal_note){
      legal.innerHTML = t.legal_note;
    }

    const planLabelText = $("#planLabelText");
    if (planLabelText){
      const planKey = state.plan === "standard" ? "plan_standard" : "plan_free";
      planLabelText.textContent = t[planKey];
    }

    const statusEl = $("#statusText");
    if (statusEl){
      const map = {
        checking:"status_checking",
        not_logged:"status_not_logged",
        free:"status_free",
        loading:"status_loading",
        ready:"status_ready",
        error:"status_error"
      };
      const k = map[state.statusCode] || "status_error";
      statusEl.textContent = t[k];
    }

    const gate = $("#videoGateText");
    if (gate){
      gate.textContent = state.plan === "standard"
        ? t.videos_gate_std
        : t.videos_gate_free;
    }

    $("#btn-ja").classList.toggle("active", lang==="ja");
    $("#btn-en").classList.toggle("active", lang==="en");

    renderTagFilterUI();
  }

  $("#btn-ja").onclick = ()=>applyLang("ja");
  $("#btn-en").onclick = ()=>applyLang("en");

  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.toggle("active", b===btn));
      document.querySelectorAll(".tab-pane").forEach(p=>{
        p.classList.toggle("active", p.id === "tab-"+tab);
      });
    });
  });

  document.addEventListener("click", (e)=>{
    const sortBtn = e.target.closest(".video-sort-btn");
    if (sortBtn){
      const mode = sortBtn.dataset.sort || "newest";
      document.querySelectorAll(".video-sort-btn").forEach(b=>{
        b.classList.toggle("active", b===sortBtn);
      });
      videoSortMode = mode;

      gaEvent("video_sort_change", { mode, plan: state.plan, lang: currentLang });

      renderVideosForPlan(state.plan, videoSortMode);
      return;
    }

    const viewBtn = e.target.closest(".view-btn");
    if (viewBtn){
      const mode = viewBtn.dataset.view || "list";
      applyViewMode(mode);

      gaEvent("video_view_change", { mode, plan: state.plan, lang: currentLang });

      return;
    }
  });

  const sleep = ms => new Promise(r=>setTimeout(r,ms));

  async function getUserWithRetry({tries=40, interval=150}={}){
    try{ await sb.auth.exchangeCodeForSession(window.location.href); }
    catch(e){ log("exchange_err", String(e)); }

    for(let i=0;i<tries;i++){
      const { data:{ user } } = await sb.auth.getUser();
      if (user) return user;
      await sleep(interval);
    }
    return null;
  }

  async function loadProfileOrCreate(userId){
    let { data:prof, error } = await sb
      .from("profiles")
      .select("id,tier,is_active,has_password")
      .eq("id", userId)
      .single();

    const notFound = error && (error.code==="PGRST116" || error.details?.includes("0 rows"));
    if (notFound){
      const up = await sb.from("profiles").upsert(
        { id:userId, tier:"free", is_active:false, has_password:false },
        { onConflict:"id" }
      );
      if (up.error){
        log("profiles upsert failed", up.error);
        return { data:null, error:up.error };
      }

      ({ data:prof, error } = await sb
        .from("profiles")
        .select("id,tier,is_active,has_password")
        .eq("id", userId)
        .single());
    }
    return { data:prof, error };
  }

  async function createCheckout(userId){
    const i18n = I18N[currentLang] || I18N["ja"] || {};
  
    const baseUrl = BILLING_CONFIG?.stripe?.standard?.payment_link_url;
    if (!baseUrl){
      console.error("missing payment_link_url in billing.json", BILLING_CONFIG);
      alert("課金設定の読み込みに失敗しました（billing.json の payment_link_url を確認してください）");
      return;
    }
  
    // Payment Linkに「メールの事前入力」を渡す（Stripe側で顧客情報入力が楽になる）
    // client_reference_id も付けておくと、Stripe側で「どのユーザーか」追跡しやすい
    const u = currentUser?.email ? String(currentUser.email) : "";
    const params = new URLSearchParams();
  
    if (u) params.set("prefilled_email", u);
    if (userId) params.set("client_reference_id", String(userId));
  
    // 既にクエリが付いているURLにも対応
    const sep = baseUrl.includes("?") ? "&" : "?";
    const url = params.toString() ? (baseUrl + sep + params.toString()) : baseUrl;
  
    gaEvent("begin_checkout", {
      plan: "standard",
      lang: currentLang,
      method: "stripe_payment_link"
    });
  
    location.href = url;
  }

  async function openPortal(userId){
    const { data:sess } = await sb.auth.getSession();
    const token = sess?.session?.access_token;
    const i18n = I18N[currentLang] || I18N["ja"] || {};

    const res = await fetch(
      "https://sqwyfscumunyhsvsvejv.functions.supabase.co/create-portal-session",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "Authorization":`Bearer ${token}`
        },
        body:JSON.stringify({
          user_id:userId,
          return_url:SITE_TOP_URL
        })
      }
    );

    if (!res.ok){
      const bodyText = await res.text().catch(()=> "");
      console.error("openPortal failed:", res.status, bodyText);
      alert(i18n.portal_error || "現在この操作を完了できません。時間をおいて再度お試しください。");
      return;
    }
    const data = await res.json();
    if (!data?.url){
      console.error("openPortal: url missing", data);
      alert(i18n.portal_error || "現在この操作を完了できません。時間をおいて再度お試しください。");
      return;
    }
    location.href = data.url;
  }

  async function updateStripeEmail(userId, newEmail){
    try{
      const { data:sess } = await sb.auth.getSession();
      const token = sess?.session?.access_token;

      const res = await fetch(
        "https://sqwyfscumunyhsvsvejv.functions.supabase.co/update-stripe-email",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ user_id: userId, new_email: newEmail })
        }
      );

      if (!res.ok){
        const t = await res.text().catch(()=> "");
        console.error("updateStripeEmail failed:", res.status, t);
        return;
      }
      const data = await res.json();
      console.log("updateStripeEmail result:", data);
    }catch(e){
      console.error("updateStripeEmail error:", e);
    }
  }

  async function handleDeleteAccount() {
    if (!currentUser) return;

    const i18n = I18N[currentLang] || I18N["ja"] || {};
    const statusEl = document.getElementById("deleteStatusMsg");

    if (statusEl){
      statusEl.style.color = "#6b6964";
      statusEl.textContent = i18n.delete_processing || "アカウントを削除しています…";
    }

    try {
      const { data: sess } = await sb.auth.getSession();
      const token = sess?.session?.access_token;
      if (!token) throw new Error("no access token");

      const res = await fetch(
        "https://sqwyfscumunyhsvsvejv.functions.supabase.co/delete-account",
        { method: "POST", headers: { Authorization: `Bearer ${token}` } },
      );

      if (!res.ok) {
        const bodyText = await res.text().catch(() => "");
        console.error("delete-account failed:", res.status, bodyText);

        const baseMsg = i18n.delete_error || "アカウント削除中にエラーが発生しました。時間をおいて再度お試しください。";
        if (statusEl){
          statusEl.textContent = baseMsg;
          statusEl.style.color = "#b00020";
        }
        return;
      }

      const doneMsg = i18n.delete_done || "アカウントを削除しました。トップページに戻ります。";
      if (statusEl){
        statusEl.textContent = doneMsg;
        statusEl.style.color = "#6b6964";
      }
      await sb.auth.signOut();
      location.href = "./";
    } catch (e) {
      console.error("handleDeleteAccount error:", e);
      const baseMsg = i18n.delete_error || "アカウント削除中にエラーが発生しました。時間をおいて再度お試しください。";
      if (statusEl){
        statusEl.textContent = baseMsg;
        statusEl.style.color = "#b00020";
      }
    }
  }

  // ループ強制（SDK + ended保険）
  function forceLoopOnIframe(iframeEl){
    try{
      if (!iframeEl || typeof window.Stream !== "function") return;
      const player = window.Stream(iframeEl);

      // 反映できるまでタイミング差があるので、少し遅延して複数回トライ
      const apply = ()=>{
        try{
          player.loop = true;
          player.autoplay = false;
        }catch{}
      };
      apply();
      setTimeout(apply, 200);
      setTimeout(apply, 800);

    }catch(e){
      console.warn("forceLoopOnIframe error:", e);
    }
  }

  function renderVideosForPlan(plan, mode = videoSortMode){
    videoSortMode = mode;

    const wrap = $("#videos");
    if (!wrap) return;
    wrap.innerHTML = "";

    const t = I18N[currentLang] || I18N["ja"];
    const cf = VIDEO_CONFIG.cloudflare;

    let episodes = VIDEO_CONFIG.episodes.filter(v => (plan === "standard") ? true : v.tier === "free");
    episodes = episodes.filter(matchSelectedTags);

    episodes.sort((a,b)=>{
      const ta = toTime(a), tb = toTime(b);
      if (videoSortMode === "oldest") return ta - tb;
      return tb - ta; // newest
    });

    if (!episodes.length){
      const p = document.createElement("p");
      p.className = "muted";
      p.textContent = t.videos_empty;
      wrap.appendChild(p);
      return;
    }

    for (const v of episodes){
      const card = document.createElement("div");
      card.className = "video-card";

      const title = getTitle(v) || "Video";
      const uid = v.cf_uid;
      const src = buildCloudflareIframeSrc(cf, uid);
      const iframeId = `cf_${v.id || uid}`;

      const playerHtml = src
        ? `
          <div style="position:relative;background:#000;aspect-ratio:16/9;">
            <iframe
              id="${iframeId}"
              src="${src}"
              title="${title}"
              frameborder="0"
              allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"
              allowfullscreen
              loading="lazy"
              style="width:100%;height:100%;position:absolute;inset:0;">
            </iframe>
          </div>
        `
        : `
          <div style="padding:14px;color:#fff;background:#111;">
            <div style="font-size:13px;opacity:.85;">Player config is missing.</div>
          </div>
        `;

      card.innerHTML = `
        ${playerHtml}
        <div class="video-title">${title}</div>
      `;
      wrap.appendChild(card);

      // ループ強制（iframe生成後に実行）
      if (src){
        const iframeEl = card.querySelector("iframe");
        forceLoopOnIframe(iframeEl);
      }
    }
  }

  async function main(){
    const urlLang = new URL(location.href).searchParams.get("lang");
    const storedLang = localStorage.getItem(langKey);
    const navLang = (navigator.language || "ja").startsWith("ja") ? "ja" : "en";
    applyLang(urlLang || storedLang || navLang);

    // 表示形式の初期値（保存済みがあれば反映）
    const storedView = localStorage.getItem("moriris_view_mode");
    applyViewMode(storedView === "grid" ? "grid" : "list");

    // ボタンのactiveも初期状態に合わせる（グリッド→リスト順のため）
    document.querySelectorAll(".view-btn").forEach(b=>{
      b.classList.toggle("active", b.dataset.view === viewMode);
    });
　　　
    await loadBillingConfig();
    
    await loadVideoConfig();

    state.statusCode = "checking";
    applyLang(currentLang);

    const user = await getUserWithRetry();
    if (!user){
      state.statusCode = "not_logged";
      applyLang(currentLang);
      $("#userEmail").textContent = "-";
      const alertBox = $("#notLoggedAlert");
      if (alertBox) alertBox.classList.remove("hidden");
      return;
    }

    currentUser = user;
    $("#userEmail").textContent = user.email || "";

    const loginEventKey = "ga_login_success_sent";
    if (!sessionStorage.getItem(loginEventKey)) {
      gtag('event', 'login_success', {
        method: 'session_restored',
        funnel_step: 'login_complete',
        lang: currentLang
      });
      sessionStorage.setItem(loginEventKey, "1");
    }

    const currentEmailEl = $("#currentEmailText");
    if (currentEmailEl) currentEmailEl.textContent = user.email || "";

    const btnChangeEmail = $("#btnChangeEmail");
    if (btnChangeEmail){
      btnChangeEmail.onclick = async ()=>{
        const input = $("#emailNew");
        const msgEl = $("#emailChangeMsg");
        if (!input || !msgEl) return;

        msgEl.style.color = "#6b6964";
        const t = I18N[currentLang] || I18N["ja"];

        const newEmail = input.value.trim();
        const currentEmail = currentUser?.email || "";

        if (!newEmail){
          msgEl.textContent = t.email_change_invalid;
          msgEl.style.color = "#b00020";
          return;
        }

        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(newEmail)){
          msgEl.textContent = t.email_change_invalid;
          msgEl.style.color = "#b00020";
          return;
        }

        if (newEmail.toLowerCase() === currentEmail.toLowerCase()){
          msgEl.textContent = t.email_change_same;
          msgEl.style.color = "#b00020";
          return;
        }

        btnChangeEmail.disabled = true;
        msgEl.textContent = "";

        try{
          const { error } = await sb.auth.updateUser(
            { email: newEmail },
            { emailRedirectTo: SITE_TOP_URL }
          );

          if (error){
            console.error("updateUser ERROR:", error);
            msgEl.textContent = t.email_change_error;
            msgEl.style.color = "#b00020";
            return;
          }

          updateStripeEmail(currentUser.id, newEmail);

          msgEl.textContent = t.email_change_sent;
          msgEl.style.color = "#6b6964";
          input.value = "";
        }catch(e){
          console.error("updateUser exception:", e);
          msgEl.textContent = t.email_change_error;
          msgEl.style.color = "#b00020";
        }finally{
          btnChangeEmail.disabled = false;
        }
      };
    }

    const profRes = await loadProfileOrCreate(user.id);
    if (profRes.error || !profRes.data){
      state.statusCode = "error";
      applyLang(currentLang);
      return;
    }

    const prof = profRes.data;
    log("profile", prof);

    state.hasPassword = !!prof.has_password;

    const pwSection       = document.getElementById("pwSection");
    const pwChangeSection = document.getElementById("pwChangeSection");
    const pwBanner        = document.getElementById("pwBanner");

    if (pwSection){
      pwSection.classList.toggle("hidden", state.hasPassword);
    }
    if (pwChangeSection){
      pwChangeSection.classList.toggle("hidden", !state.hasPassword);
    }

    if (!state.hasPassword) {
      if (pwBanner) {
        pwBanner.classList.remove("hidden");
        pwBanner.onclick = ()=>{
          document.querySelectorAll(".tab-btn").forEach(btn=>{
            btn.classList.toggle("active", btn.dataset.tab === "account");
          });
          document.querySelectorAll(".tab-pane").forEach(pane=>{
            pane.classList.toggle("active", pane.id === "tab-account");
          });
          const target = document.getElementById("pwSection");
          if (target) target.scrollIntoView({ behavior:"smooth", block:"center" });
        };
      }
    } else {
      if (pwBanner) pwBanner.classList.add("hidden");
    }

    const pwForm = document.getElementById("pwForm");
    const pwMsg  = document.getElementById("pwMsg");
    if (pwForm){
      pwForm.onsubmit = async (e)=>{
        e.preventDefault();
        if (!currentUser) return;

        const t = I18N[currentLang] || I18N["ja"];
        if (pwMsg){ pwMsg.textContent = ""; pwMsg.style.color = "#6b6964"; }

        const p1 = (document.getElementById("pwNew")?.value || "").trim();
        const p2 = (document.getElementById("pwNew2")?.value || "").trim();

        if (!p1){ if (pwMsg){ pwMsg.textContent = t.pw_setup_need_password; pwMsg.style.color = "#b00020"; } return; }
        if (!p2){ if (pwMsg){ pwMsg.textContent = t.pw_setup_need_confirm; pwMsg.style.color = "#b00020"; } return; }
        if (p1.length < 8){ if (pwMsg){ pwMsg.textContent = t.pw_setup_short; pwMsg.style.color = "#b00020"; } return; }
        if (p1 !== p2){ if (pwMsg){ pwMsg.textContent = t.pw_setup_mismatch; pwMsg.style.color = "#b00020"; } return; }

        const btn = document.getElementById("pwSubmit");
        if (btn) btn.disabled = true;

        try{
          const { error:updateErr } = await sb.auth.updateUser({ password:p1 });
          if (updateErr){
            console.error("updateUser(set password) error:", updateErr);
            if (pwMsg){ pwMsg.textContent = t.pw_setup_error; pwMsg.style.color = "#b00020"; }
            return;
          }

          try{
            await sb.from("profiles").update({ has_password:true }).eq("id", currentUser.id);
          }catch(e2){
            console.warn("profiles.has_password update error:", e2);
          }

          state.hasPassword = true;
          if (pwSection) pwSection.classList.add("hidden");
          if (pwChangeSection) pwChangeSection.classList.remove("hidden");
          if (pwBanner) pwBanner.classList.add("hidden");

          if (pwMsg){ pwMsg.textContent = t.pw_setup_success; pwMsg.style.color = "#6b6964"; }

          const input1 = document.getElementById("pwNew");
          const input2 = document.getElementById("pwNew2");
          if (input1) input1.value = "";
          if (input2) input2.value = "";
        }catch(e){
          console.error("pw setup exception:", e);
          if (pwMsg){ pwMsg.textContent = t.pw_setup_error; pwMsg.style.color = "#b00020"; }
        }finally{
          if (btn) btn.disabled = false;
        }
      };
    }

    const pwChangeForm = document.getElementById("pwChangeForm");
    const pwChangeMsg  = document.getElementById("pwChangeMsg");
    if (pwChangeForm){
      pwChangeForm.onsubmit = async (e)=>{
        e.preventDefault();
        if (!currentUser) return;

        const t = I18N[currentLang] || I18N["ja"];
        if (pwChangeMsg){ pwChangeMsg.textContent = ""; pwChangeMsg.style.color = "#6b6964"; }

        const p1 = (document.getElementById("pwChangeNew")?.value || "").trim();
        const p2 = (document.getElementById("pwChangeNew2")?.value || "").trim();

        if (!p1){ if (pwChangeMsg){ pwChangeMsg.textContent = t.pw_setup_need_password; pwChangeMsg.style.color = "#b00020"; } return; }
        if (!p2){ if (pwChangeMsg){ pwChangeMsg.textContent = t.pw_setup_need_confirm; pwChangeMsg.style.color = "#b00020"; } return; }
        if (p1.length < 8){ if (pwChangeMsg){ pwChangeMsg.textContent = t.pw_setup_short; pwChangeMsg.style.color = "#b00020"; } return; }
        if (p1 !== p2){ if (pwChangeMsg){ pwChangeMsg.textContent = t.pw_setup_mismatch; pwChangeMsg.style.color = "#b00020"; } return; }

        const btn = document.getElementById("pwChangeSubmit");
        if (btn) btn.disabled = true;

        try{
          const { error:updateErr } = await sb.auth.updateUser({ password:p1 });
          if (updateErr){
            console.error("updateUser(change password) error:", updateErr);
            if (pwChangeMsg){ pwChangeMsg.textContent = t.pw_setup_error; pwChangeMsg.style.color = "#b00020"; }
            return;
          }

          if (pwChangeMsg){
            pwChangeMsg.textContent = t.pw_change_success || t.pw_setup_success;
            pwChangeMsg.style.color = "#6b6964";
          }

          const input1 = document.getElementById("pwChangeNew");
          const input2 = document.getElementById("pwChangeNew2");
          if (input1) input1.value = "";
          if (input2) input2.value = "";
        }catch(e){
          console.error("pw change exception:", e);
          if (pwChangeMsg){ pwChangeMsg.textContent = t.pw_setup_error; pwChangeMsg.style.color = "#b00020"; }
        }finally{
          if (btn) btn.disabled = false;
        }
      };
    }

    const pwShowSetup = document.getElementById("pwShowSetup");
    if (pwShowSetup){
      pwShowSetup.addEventListener("change", ()=>{
        const type = pwShowSetup.checked ? "text" : "password";
        const f1 = document.getElementById("pwNew");
        const f2 = document.getElementById("pwNew2");
        if (f1) f1.type = type;
        if (f2) f2.type = type;
      });
    }

    const pwShowChange = document.getElementById("pwShowChange");
    if (pwShowChange){
      pwShowChange.addEventListener("change", ()=>{
        const type = pwShowChange.checked ? "text" : "password";
        const f1 = document.getElementById("pwChangeNew");
        const f2 = document.getElementById("pwChangeNew2");
        if (f1) f1.type = type;
        if (f2) f2.type = type;
      });
    }

    const tier = (prof.tier || "free").toLowerCase();
    const isActive = !!prof.is_active;

    const deleteBox = document.getElementById("deleteConfirmBox");
    const deleteStatusMsg = document.getElementById("deleteStatusMsg");
    const btnDeleteConfirm = document.getElementById("btnDeleteConfirm");
    const btnDeleteCancel  = document.getElementById("btnDeleteCancel");

    if (btnDeleteConfirm) btnDeleteConfirm.onclick = ()=>handleDeleteAccount();
    if (btnDeleteCancel){
      btnDeleteCancel.onclick = ()=>{
        if (deleteBox) deleteBox.classList.add("hidden");
        if (deleteStatusMsg) deleteStatusMsg.textContent = "";
      };
    }

    if (!isActive || tier==="free"){
      state.plan = "free";
      state.statusCode = "free";
      applyLang(currentLang);

      const btnSubMain   = $("#btnSubscribe");
      const btnSubVideos = $("#btnSubscribeVideos");
      const btnCancel    = $("#btnCancel");
      const btnDelete    = $("#btnDeleteAccount");

      [btnSubMain, btnSubVideos].forEach(b=>{
        if (!b) return;
        b.classList.remove("hidden");
        b.onclick = ()=>{
          gaEvent("membership_cta_click", {
            cta_name: "standard_start",
            plan: "standard",
            page: "members",
            lang: currentLang,
            destination: "stripe_checkout",
            outbound: 1
          });
          createCheckout(user.id);
        };
      });

      if (btnCancel){ btnCancel.classList.add("hidden"); btnCancel.onclick = null; }
      if (btnDelete){
        btnDelete.classList.remove("hidden");
        btnDelete.onclick = ()=>{
          if (deleteBox) deleteBox.classList.remove("hidden");
          if (deleteStatusMsg){
            deleteStatusMsg.textContent = "";
            deleteStatusMsg.style.color = "#6b6964";
          }
        };
      }

      renderVideosForPlan("free", videoSortMode);
    }else{
      state.plan = "standard";

      const key = `ga_standard_started_${user.id}`;
      if (!localStorage.getItem(key)) {
        gaEvent("standard_started", { plan: "standard", page: "members", lang: currentLang });
        localStorage.setItem(key, "1");
      }

      state.statusCode = "loading";
      applyLang(currentLang);

      const btnSubMain   = $("#btnSubscribe");
      const btnSubVideos = $("#btnSubscribeVideos");
      const btnCancel    = $("#btnCancel");
      const btnDelete    = $("#btnDeleteAccount");

      [btnSubMain, btnSubVideos].forEach(b=>{
        if (!b) return;
        b.classList.add("hidden");
        b.onclick = null;
      });

      if (btnCancel){
        btnCancel.classList.remove("hidden");
        btnCancel.onclick = ()=>openPortal(user.id);
      }
      if (btnDelete){ btnDelete.classList.add("hidden"); btnDelete.onclick = null; }
      if (deleteBox) deleteBox.classList.add("hidden");
      if (deleteStatusMsg) deleteStatusMsg.textContent = "";

      renderVideosForPlan("standard", videoSortMode);

      state.statusCode = "ready";
      applyLang(currentLang);
    }

    $("#logout").onclick = async ()=>{
      try{ await sb.auth.signOut(); }catch{}
      location.replace("./");
    };
  }

  main();
</script>
</body>
</html>
