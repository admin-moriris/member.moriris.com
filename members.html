<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>

  <!-- Google tag (gtag.js)  -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-HWRX6Q9K3E"></script>
  <script>
    const isDebug = new URLSearchParams(location.search).get('debug') === '1';
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-HWRX6Q9K3E', {
      debug_mode: isDebug,
      linker: { domains: ['official.moriris.com', 'member.moriris.com'] }
    });
  </script>

  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MORIRIS MEMBERSHIP</title>

  <style>
    :root{
      --bg:#faf8f4;
      --panel:#ffffff;
      --ink:#24311c;
      --muted:#6b6964;
      --accent:#75c29c;
      --accent-dark:#0b5130;
      --radius:20px;
      --shadow:0 10px 32px rgba(0,0,0,.18);
    }
    *{box-sizing:border-box;}
    html,body{ margin:0; height:100%; }
    body{
      min-height:100vh;
      background-color:#faf8f4;
      background-image:url("/assets/hero-forest.png");
      background-repeat:no-repeat;
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      color:var(--ink);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto;
    }
    .page{ max-width:1120px; margin:0 auto; padding:0 18px 32px; }

    .header-wrap{
      position:sticky; top:0; z-index:100; padding-bottom:10px;
      background: linear-gradient(to bottom, rgba(250,248,244,1) 0%, rgba(250,248,244,.95) 70%, rgba(250,248,244,0) 100%);
      backdrop-filter:blur(4px);
    }

    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:18px; }
    .brand{ display:flex; align-items:center; gap:18px; }
    .brand img{ max-width:220px; height:auto; display:block; filter:drop-shadow(0 4px 12px rgba(0,0,0,.18)); }
    .brand-title{ display:flex; align-items:center; }
    .brand-title span{ font-size:20px; letter-spacing:.22em; text-transform:uppercase; color:#666666; font-weight:500; white-space:nowrap; }

    .lang{ display:flex; gap:8px; align-items:center; }
    .lang button{
      border:1px solid #ddd; background:#fff; border-radius:999px;
      padding:6px 12px; cursor:pointer; font-size:13px;
    }
    .lang .active{ border-color:var(--accent); color:var(--accent-dark); font-weight:600; }

    .pw-banner{
      background:#ffe7e3; border:1px solid #ffb3a7; color:#8b1a07;
      border-radius:12px; padding:10px 14px; margin-bottom:16px;
      font-size:14px; font-weight:600; cursor:pointer;
    }

    .user-box{ display:flex; align-items:center; gap:10px; font-size:13px; color:var(--muted); justify-content:flex-end; }
    .pill{ border-radius:999px; background:#ffffff; padding:4px 10px; border:1px solid rgba(0,0,0,.08); }
    .btn{
      border-radius:999px; border:1px solid #ddd; background:#fff;
      padding:7px 12px; cursor:pointer; font-size:13px; color:var(--ink);
    }
    .btn-primary{ background:var(--accent); border-color:transparent; color:var(--accent-dark); font-weight:600; }
    .btn-outline{ background:#fff; color:var(--ink); }
    .btn-danger{ background:#ffe7e3; border-color:#ffb3a7; color:#8b1a07; font-weight:600; }
    .input{
      border-radius:999px; border:1px solid #ddd; background:#fff;
      padding:7px 10px; font-size:13px; min-width:220px;
    }

    .tabs{
      margin-top:8px;
      background:rgba(255,255,255,.95);
      border-radius:999px;
      box-shadow:0 4px 18px rgba(0,0,0,.08);
      padding:4px;
      display:flex;
      gap:4px;
      overflow:auto;
    }
    .tab-btn{
      flex:1; min-width:0; border:none; background:transparent;
      border-radius:999px; padding:10px 12px; font-size:14px;
      cursor:pointer; letter-spacing:.12em;
    }
    .tab-btn.active{ background:var(--accent); color:var(--accent-dark); font-weight:600; }
    .add-gap { margin-bottom: 20px; }

    main{ margin-top:40px; }
    .card{ background:var(--panel); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px 20px 24px; margin-bottom:18px; }
    .tab-pane{display:none;}
    .tab-pane.active{display:block;}

    h2{ margin:0 0 10px; font-size:20px; }
    h3{ margin:0 0 6px; font-size:16px; }
    p{ margin:6px 0; line-height:1.7; font-size:14px; }
    .muted{color:var(--muted);}

    .home-layout{ display:flex; flex-direction:column; gap:18px; }
    .status-box{
      background:#f5ffe9;
      border-radius:16px;
      padding:12px 14px;
      font-size:13px;
      margin-top:8px;
      border:1px solid #d7e8c4;
    }
    .cta-row{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }

    .video-grid{ display:flex; flex-direction:column; gap:22px; margin-top:12px; }
    .video-card{
      background:var(--panel);
      border-radius:16px;
      box-shadow:var(--shadow);
      overflow:hidden;
      width:100%;
      max-width:none;
      margin:0;
    }
    .video-title{ padding:10px 12px 12px; font-size:14px; font-weight:600; }

    .video-sort{
      margin-top:6px;
      margin-bottom:6px;
      font-size:13px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .video-sort-btn{
      border-radius:999px;
      border:1px solid #ccc;
      background:#fff;
      padding:4px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .video-sort-btn.active{
      background:var(--accent);
      border-color:var(--accent);
      color:var(--accent-dark);
      font-weight:600;
    }

    a{color:#0d6b45;text-decoration:none;}
    a:hover{text-decoration:underline;}

    footer{
      margin-top:24px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }
    .sns-row{
      display:flex;
      justify-content:center;
      gap:16px;
      margin:10px 0 6px;
    }
    .sns-icon{
      width:40px;
      height:40px;
      border-radius:999px;
      background:#ffffff;
      box-shadow:0 4px 12px rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      text-decoration:none;
    }
    .sns-icon svg{ width:20px; height:20px; fill:#3f6f4b; }
    .hidden{display:none;}

    .site-header{
      position:fixed;
      top:0; left:0; right:0;
      z-index:100;
      background: linear-gradient(to bottom, rgba(250,248,244,1) 0%, rgba(250,248,244,.95) 70%, rgba(250,248,244,0) 100%);
      backdrop-filter:blur(4px);
    }
    .main-page{ padding-top:180px; }

    @media (max-width: 768px){
      .topbar{ flex-direction:column; align-items:flex-start; gap:8px; }
      .brand{ gap:10px; }
      .brand img{ max-width:180px; }
      .brand-title span{ font-size:16px; letter-spacing:.16em; }
      .user-box{ justify-content:flex-start; flex-wrap:wrap; }
      .lang{ justify-content:flex-start; }
      .tabs{
        border-radius:16px;
        padding:4px 6px;
        gap:6px;
        -webkit-overflow-scrolling:touch;
      }
      .tab-btn{
        flex:0 0 auto;
        white-space:nowrap;
        font-size:12px;
        letter-spacing:.08em;
        padding:8px 10px;
      }
      .main-page{ padding-top:210px; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <header class="site-header">
    <div class="page header-inner">
      <div class="topbar">
        <div class="brand">
          <img src="/assets/logo-moriris.png" alt="Moriris" />
          <div class="brand-title">
            <span data-i18n="brand_meta">MEMBERSHIP</span>
          </div>
        </div>

        <div>
          <div class="user-box">
            <span data-i18n="logged_in_label">ログイン中：</span>
            <span id="userEmail" class="pill"></span>
            <button id="logout" class="btn btn-outline" data-i18n="logout">ログアウト</button>
          </div>
          <div class="lang" style="margin-top:6px;justify-content:flex-end;">
            <button id="btn-en">EN</button>
            <button id="btn-ja" class="active">JP</button>
          </div>
        </div>
      </div>

      <nav class="tabs">
        <button class="tab-btn active" data-tab="home" data-i18n="tab_home">HOME</button>
        <button class="tab-btn" data-tab="animation" data-i18n="tab_animation">ANIMATION</button>
        <button class="tab-btn" data-tab="account" data-i18n="tab_account">ACCOUNT</button>
      </nav>
    </div>
  </header>

  <div class="page main-page">
    <main>
      <!-- 未ログイン時に表示する案内 -->
      <div id="notLoggedAlert" class="card hidden" style="background:#fff7e0;border:1px solid #f3d38a;">
        <p id="notLoggedText" class="muted" style="font-size:14px;margin-bottom:8px;">
          ログイン状態が確認できませんでした。
        </p>
        <a id="notLoggedLink" href="./" style="font-size:14px;">ログイン画面に戻る</a>
      </div>

      <!-- HOME -->
      <section id="tab-home" class="tab-pane active">
        <div class="card home-layout">
          <div id="pwBanner" class="pw-banner hidden">
            パスワードが未設定です。こちらをクリックして設定してください。
          </div>

          <div>
            <h2>ようこそ、モリリス メンバーシップへ</h2>
            <p class="muted">メンバー限定のアニメやデジタル絵本を、このページからお楽しみいただけます。</p>
            <img
              src="https://member.moriris.com/assets/home-img.png"
              alt="Moriris members home illustration"
              style="width:100%;max-width:720px;border-radius:16px;margin:16px 0;"
            />
          </div>

          <div>
            <h3>メンバーシップの楽しみ方</h3>
            <ul style="margin:4px 0 0;padding-left:18px;font-size:13px;line-height:1.7;">
              <li>ANIMATIONタブからメンバー限定アニメを視聴できます。</li>
              <li>プランの確認や変更は ACCOUNTタブからいつでも行うことができます。</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- ANIMATION -->
      <section id="tab-animation" class="tab-pane">
        <div class="card">
          <h2>メンバー限定アニメ</h2>
          <p class="muted" id="animGateText">Standardプランに登録すると、メンバー限定のアニメを視聴できます。</p>

          <button id="btnSubscribeAnim" class="btn btn-primary hidden add-gap">
            Standardプランに登録する
          </button>

          <div class="video-sort" id="videoSortRow">
            <span>表示順：</span>
            <button type="button" class="video-sort-btn active" data-sort="episode">エピソード順</button>
            <button type="button" class="video-sort-btn" data-sort="new">新着順</button>
          </div>

          <div id="videos" class="video-grid"></div>
        </div>
      </section>

      <!-- ACCOUNT -->
      <section id="tab-account" class="tab-pane">
        <div class="card">
          <h2>アカウント・プラン情報</h2>
          <p class="muted">現在のプランやサブスクリプションの変更・解約は、このページから行うことができます。</p>

          <div class="status-box">
            <div>
              <span>現在のプラン：</span>
              <span id="planLabelText">Free</span>
            </div>
            <p id="statusText" class="muted" style="margin-top:6px;">ログイン状態を確認しています…</p>
          </div>

          <div class="cta-row">
            <button id="btnSubscribe" class="btn btn-primary hidden">Standardプランに登録する</button>
            <button id="btnCancel" class="btn btn-danger hidden">サブスクを解約する</button>
            <button id="btnDeleteAccount" class="btn btn-danger hidden">アカウントを削除する</button>
          </div>

          <hr style="margin:18px 0;border:none;border-top:1px solid #e0e0e0;" />

          <h3>メールアドレスの変更</h3>
          <p class="muted">新しいメールアドレスを入力すると、確認メールを送信します。メール内のリンクから変更を完了してください。</p>

          <p style="font-size:13px;margin-top:8px;">
            <span>現在のメールアドレス：</span>
            <strong id="currentEmailText"></strong>
          </p>

          <div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
            <input id="emailNew" type="email" class="input" placeholder="new-address@example.com"/>
            <button id="btnChangeEmail" class="btn btn-outline">変更用メールを送信</button>
          </div>

          <p id="emailChangeMsg" class="muted" style="font-size:12px;margin-top:6px;"></p>
        </div>
      </section>
    </main>

    <footer>
      <div class="sns-row">
        <a class="sns-icon" href="https://www.youtube.com/@moriris_world" target="_blank" rel="noopener noreferrer" aria-label="YouTube">
          <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M21.6 7.2s-.2-1.5-.8-2.1c-.7-.8-1.5-.8-1.9-.9C15.6 4 12 4 12 4s-3.6 0-6.9.2c-.4.1-1.2.1-1.9.9-.6.6-.8 2.1-.8 2.1S2 9.1 2 11v1.9c0 1.9.2 3.8.2 3.8s.2 1.5.8 2.1c.7.8 1.8.8 2.3.9 1.7.2 7 .3 7 .3s3.6 0 6.9-.2c.4-.1 1.2-.1 1.9-.9.6-.6.8-2.1.8-2.1s.2-1.9.2-3.8V11c0-1.9-.2-3.8-.2-3.8zM10 9.5l4.8 2.5L10 14.5V9.5z"/></svg>
        </a>
      </div>
      <div>最新情報は各種SNSでお知らせします。</div>
      <div id="legalLinks" style="margin-top:4px;font-size:11px;"></div>
    </footer>
  </div>

<script>
  const SUPABASE_URL = "https://sqwyfscumunyhsvsvejv.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNxd3lmc2N1bXVueWhzdnN2ZWp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0ODM4NDQsImV4cCI6MjA3NzA1OTg0NH0.P_6eP5E_Du82IEI1gzn4PKQjnqlVGoptmZZR9aIiXNU";
  const SITE_TOP_URL = "https://member.moriris.com/";
  const PRICE_ID_STANDARD = "price_1SZ4pbJBnnPY5Sg2uplAWUVc";

  // NOTE: detectSessionInUrl は true のままでOKだが、exchangeCodeForSession は「必要時のみ」実行する
  const sb = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY,
    {
      auth: { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true }
    }
  );

  const isLocal = ["localhost", "127.0.0.1"].includes(location.hostname);
  const debugOn = isLocal && new URL(location.href).searchParams.get("debug")==="1";
  const log = (...a)=>{ if(!debugOn) return; console.log("[debug]", ...a); };

  const state = { plan:"free", hasPassword:false };
  let currentUser = null;

  // 外出しJSON
  const VIDEO_JSON_URL = "/data/video.json";
  const videoConfig = {
    cloudflare: { customer_code:"", iframe_params:"controls=true&loop=true&preload=metadata" },
    episodes: []
  };

  // ====== auth code がURLにある時だけ交換（重要） ======
  async function safeExchangeIfNeeded(){
    const url = new URL(location.href);
    const hasCode = url.searchParams.get("code")
      || url.searchParams.get("access_token")
      || url.hash.includes("access_token=");
    if (!hasCode) return;
    try{
      await sb.auth.exchangeCodeForSession(location.href);
      // URLを綺麗にする（同じコードを何度も処理しない）
      url.searchParams.delete("code");
      url.searchParams.delete("state");
      history.replaceState({}, "", url.toString());
    }catch(e){
      log("exchangeCodeForSession failed:", e);
    }
  }

  const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

  async function getUserStable({tries=30, interval=150}={}){
    // 1) 必要な時だけexchange
    await safeExchangeIfNeeded();

    // 2) セッションから読む（最速）
    for(let i=0;i<tries;i++){
      const { data: sess } = await sb.auth.getSession();
      if (sess?.session?.user) return sess.session.user;

      const { data: u } = await sb.auth.getUser();
      if (u?.user) return u.user;

      await sleep(interval);
    }
    return null;
  }

  async function loadVideoConfig(){
    try{
      const res = await fetch(VIDEO_JSON_URL, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      if (data?.cloudflare?.customer_code) videoConfig.cloudflare.customer_code = String(data.cloudflare.customer_code);
      if (data?.cloudflare?.iframe_params) videoConfig.cloudflare.iframe_params = String(data.cloudflare.iframe_params);

      const eps = Array.isArray(data?.episodes) ? data.episodes : [];
      videoConfig.episodes = eps.filter(ep => !Object.prototype.hasOwnProperty.call(ep, "visible") || ep.visible !== false);

      log("video config loaded", videoConfig);
    }catch(e){
      console.error("video json load error", e);
      videoConfig.episodes = [];
    }
  }

  function getCfBase(){
    const code = videoConfig.cloudflare.customer_code;
    return `https://${code}.cloudflarestream.com`;
  }

  const tokenCacheKey = (uid)=>`cf_stream_token_${uid}`;

  async function getSignedTokenForUid(videoUid){
    const cached = sessionStorage.getItem(tokenCacheKey(videoUid));
    if (cached) return cached;

    const { data:sess } = await sb.auth.getSession();
    const token = sess?.session?.access_token;
    if (!token) throw new Error("no supabase access token");

    // 推奨：supabase.co/functions/v1/ の形式（確実）
    const fnUrl = "https://sqwyfscumunyhsvsvejv.supabase.co/functions/v1/get-stream-token";

    const res = await fetch(fnUrl, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${token}`
      },
      body: JSON.stringify({ video_uid: videoUid })
    });

    if (!res.ok){
      const t = await res.text().catch(()=> "");
      throw new Error(`get-stream-token failed: ${res.status} ${t}`);
    }
    const data = await res.json();
    if (!data?.token) throw new Error("token missing");

    sessionStorage.setItem(tokenCacheKey(videoUid), data.token);
    return data.token;
  }

  async function buildIframeSrc(videoUid){
    const token = await getSignedTokenForUid(videoUid);
    const base = getCfBase();
    const qs = videoConfig.cloudflare.iframe_params || "controls=true&loop=true&preload=metadata";
    return `${base}/${encodeURIComponent(token)}/iframe?${qs}`;
  }

  let videoSortMode = "episode";

  function isStandardUser(){
    return state.plan === "standard";
  }

  function renderVideosForPlan(plan, mode = videoSortMode){
    videoSortMode = mode;
    const wrap = document.getElementById("videos");
    if (!wrap) return;
    wrap.innerHTML = "";

    // tierフィルタ（freeは free動画のみ）
    let episodes = videoConfig.episodes.filter(v => (plan === "standard") ? true : v.tier === "free");

    episodes.sort((a,b)=>{
      if (mode === "new") return (b.ep||0) - (a.ep||0);
      return (a.ep||0) - (b.ep||0);
    });

    if (!episodes.length){
      const p = document.createElement("p");
      p.className = "muted";
      p.textContent = "現在、視聴可能な動画がありません。";
      wrap.appendChild(p);
      return;
    }

    for (const v of episodes){
      const card = document.createElement("div");
      card.className = "video-card";

      const title = v.title || `Episode ${v.ep || ""}`;
      const uid = v.cf_uid;

      card.innerHTML = `
        <div style="position:relative;background:#000;aspect-ratio:16/9;">
          <div class="muted" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;">
            Loading…
          </div>
        </div>
        <div class="video-title">${title}</div>
      `;
      wrap.appendChild(card);

      (async ()=>{
        try{
          if (!uid) throw new Error("cf_uid missing in json");

          // free動画のときだけ、トークンが要らない公開iframeにしたいならここで分岐可能。
          // 今回は free動画も署名必須と想定して token 取得する。

          const src = await buildIframeSrc(uid);

          const frameWrap = card.querySelector("div[style*='aspect-ratio']");
          if (!frameWrap) return;

          frameWrap.innerHTML = `
            <iframe
              src="${src}"
              title="${title}"
              frameborder="0"
              allow="accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture;"
              allowfullscreen
              loading="lazy"
              style="width:100%;height:100%;position:absolute;inset:0;border:none;"
            ></iframe>
          `;
        }catch(e){
          console.error(e);
          const frameWrap = card.querySelector("div[style*='aspect-ratio']");
          if (frameWrap){
            frameWrap.innerHTML = `
              <div class="muted" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#fff;font-size:13px;">
                Failed to load
              </div>
            `;
          }
        }
      })();
    }
  }

  document.addEventListener("click", (e)=>{
    const videoSortBtn = e.target.closest(".video-sort-btn");
    if (videoSortBtn){
      const mode = videoSortBtn.dataset.sort || "episode";
      document.querySelectorAll(".video-sort-btn").forEach(b=> b.classList.toggle("active", b===videoSortBtn));
      renderVideosForPlan(state.plan, mode);
    }
  });

  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tab = btn.dataset.tab;
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.toggle("active", b===btn));
      document.querySelectorAll(".tab-pane").forEach(p=>{
        p.classList.toggle("active", p.id === "tab-"+tab);
      });
    });
  });

  async function loadProfileOrCreate(userId){
    let { data:prof, error } = await sb
      .from("profiles")
      .select("id,tier,is_active,has_password")
      .eq("id", userId)
      .single();

    const notFound = error && (error.code==="PGRST116" || String(error.details||"").includes("0 rows"));
    if (notFound){
      const up = await sb.from("profiles").upsert(
        { id:userId, tier:"free", is_active:false, has_password:false },
        { onConflict:"id" }
      );
      if (up.error) return { data:null, error:up.error };

      ({ data:prof, error } = await sb
        .from("profiles")
        .select("id,tier,is_active,has_password")
        .eq("id", userId)
        .single());
    }
    return { data:prof, error };
  }

  async function main(){
    await loadVideoConfig();

    const user = await getUserStable();
    if (!user){
      document.getElementById("userEmail").textContent = "-";
      const alertBox = document.getElementById("notLoggedAlert");
      if (alertBox) alertBox.classList.remove("hidden");
      document.getElementById("statusText").textContent = "未ログインです。";
      return;
    }

    currentUser = user;
    document.getElementById("userEmail").textContent = user.email || "";
    document.getElementById("currentEmailText").textContent = user.email || "";
    document.getElementById("statusText").textContent = "ログインしました。";

    const profRes = await loadProfileOrCreate(user.id);
    if (profRes.error || !profRes.data){
      console.error("profile load error", profRes.error);
      document.getElementById("statusText").textContent = "プロフィールの取得に失敗しました。";
      return;
    }

    const prof = profRes.data;
    const tier = String(prof.tier || "free").toLowerCase();
    const isActive = !!prof.is_active;

    if (isActive && tier === "standard"){
      state.plan = "standard";
      document.getElementById("planLabelText").textContent = "Standard";
      document.getElementById("animGateText").textContent = "メンバー限定アニメを視聴できます。";
    }else{
      state.plan = "free";
      document.getElementById("planLabelText").textContent = "Free";
      document.getElementById("animGateText").textContent = "Standardプランに登録すると、メンバー限定のアニメを視聴できます。";
    }

    renderVideosForPlan(state.plan, videoSortMode);

    document.getElementById("logout").onclick = async ()=>{
      try{ await sb.auth.signOut(); }catch{}
      location.replace("./");
    };
  }

  main();
</script>

</body>
</html>
