<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Moriris Members – Videos</title>
  <style>
    body{font-family:system-ui;margin:16px}
    .top{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:16px;margin-top:16px}
    .card{border:1px solid #ddd;border-radius:12px;overflow:hidden}
    .title{padding:10px 12px;font-weight:600}
    .frame-wrap{position:relative;background:#000;aspect-ratio:16/9}
    .overlay{position:absolute;inset:0;background:transparent}
    .hidden{display:none}
    .muted{color:#666}
  </style>
</head>
<body>
  <div class="top">
    <h1>Members Videos</h1>
    <div>
      <span id="user"></span>
      <button id="logout">ログアウト</button>
    </div>
  </div>

  <p id="status" class="muted">ログイン状態を確認しています…</p>

  <div id="gate" class="hidden">
    <p>会員ではありません。<a href="./">ログインページへ戻る</a></p>
    <p>※ 決済連携後は入会ボタンでStripe Checkoutへ飛ばせます</p>
  </div>

  <div id="list" class="grid hidden"></div>

  <!-- 1) Supabase ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- 2) Supabase 初期化 -->
  <script>
    const SUPABASE_URL = "https://sqwyfscumunyhsvsvejv.supabase.co";
    const SUPABASE_ANON_KEY = "YOUR-ANON-KEY-HERE"; /* ← ここに実際の anon key を入れる */
    window.sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });
  </script>

  <!-- 3) 会員チェック & 動画一覧 -->
  <script>
    // 右クリック/キーボードの簡易抑止（完全防止ではありません）
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if ((e.ctrlKey||e.metaKey) && ['s','u','p','c'].includes(e.key.toLowerCase())) e.preventDefault();
      if (e.key === 'F12') e.preventDefault();
    });

    const $ = sel => document.querySelector(sel);
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    async function getUserWithRetry(maxTries = 20, intervalMs = 150) {
      // セッション初期化を待ちつつ user を取得
      for (let i = 0; i < maxTries; i++) {
        const s = await sb.auth.getSession();
        if (s?.data?.session?.user) return s.data.session.user;
        const u = await sb.auth.getUser();
        if (u?.data?.user) return u.data.user;
        await sleep(intervalMs);
      }
      return null;
    }

    (async () => {
      try {
        const status = $('#status');

        // 1) ログイン済みか安全に確認（初期化待ち込み）
        const user = await getUserWithRetry();
        if (!user) {
          status.textContent = '未ログインです。ログインページへ戻ります。';
          // 直リンク対策で相対パスに
          location.replace('./');
          return;
        }
        $('#user').textContent = user.email || '';
        status.textContent = '会員ステータスを確認中…';

        // 2) 会員（is_active）チェック
        const { data: profile, error: pe } = await sb
          .from('profiles')
          .select('is_active')
          .eq('id', user.id)
          .single();

        if (pe) {
          console.error('profile error:', pe);
          status.textContent = '読み込みに失敗しました。再読み込みしてください。';
          return;
        }
        if (!profile?.is_active) {
          status.textContent = '';
          $('#gate').classList.remove('hidden');
          return;
        }

        status.textContent = '動画を読み込み中…';

        // 3) 動画リスト取得
        const { data: videos, error } = await sb
          .from('member_videos')
          .select('id,title,yt_id')
          .eq('published', true)
          .order('id', { ascending: false });

        if (error) {
          console.error('video error:', error);
          status.textContent = '動画の読み込みに失敗しました。';
          return;
        }

        status.textContent = '';
        const list = $('#list');
        list.classList.remove('hidden');
        list.innerHTML = videos.map(v => {
          const src = `https://www.youtube-nocookie.com/embed/${encodeURIComponent(v.yt_id)}?rel=0&modestbranding=1&playsinline=1&controls=1`;
          return `
            <div class="card">
              <div class="frame-wrap">
                <iframe
                  src="${src}"
                  title="${escapeHtml(v.title)}"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  allowfullscreen
                  referrerpolicy="no-referrer"
                  loading="lazy"
                  style="width:100%;height:100%;position:absolute;inset:0;">
                </iframe>
                <div class="overlay"></div>
              </div>
              <div class="title">${escapeHtml(v.title)}</div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error(e);
        alert('エラーが発生しました。再読み込みしてください。');
      }

      // ログアウト
      $('#logout').onclick = async () => {
        await sb.auth.signOut();
        location.replace('./');
      };
    })();

    function escapeHtml(s){
      return s?.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) || '';
    }
  </script>
</body>
</html>
